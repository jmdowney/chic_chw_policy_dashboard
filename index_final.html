<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>CHW Policy Dashboard</title>
  <meta name="viewport" content="initial-scale=1,width=device-width">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Anton' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css?family=Playfair Display" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.rawgit.com/Keyang/node-csvtojson/d41f44aa/browser/csvtojson.min.js"></script>

  <style>
    /* CSS Variables - Design System */
    :root {
      /* Colors */
      --color-primary: #4F2049;
      --color-primary-light: #340C2F;
      --color-secondary: #9272d9;
      --color-accent: #20BDC5;
      --color-warning: #F36744;
      --color-neutral: #999999;
      --color-light-gray: #dbdbdb;
      --color-background: #F4F1EB;
      --color-white: #ffffff;
      --color-black: #111111;
      
      /* Typography */
      --font-primary: 'Helvetica Neue', 'Arial Narrow', sans-serif;
      --font-display: 'Anton', sans-serif;
      
      /* Spacing */
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      
      /* Border radius */
      --radius-sm: 3px;
      --radius-md: 5px;
      --radius-lg: 10px;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.1);
      
      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.2s ease;
      --transition-slow: 0.3s ease;
    }

    /* Mobile */
    @media screen and (max-width: 768px) {

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0px;
        padding: 0px;
        background-color: var(--color-background);
      }

      .container {
        display: grid;
        grid-template-columns: repeat(4, minmax(0px, 1fr));
        grid-template-rows: 10vh 6vh 50vh 34vh;
        max-width: 100%;
      }

      .header {
        grid-column: 1 / span 4;
        display: grid;
      }

      .header-section {
        grid-row: 1;
        display: grid;
        align-content: center;
      }

      /* Child containers within header */
      .left {
        grid-column: 1 / span 1;
      }

      .middle {
        grid-column: 2 / span 3;
      }

      .right {
        grid-column: 1 / span 4;
        grid-row: 2 / span 1;
        display: grid;
        text-align: center;
        margin: .5em;
      }

      /* Map and sidebar */
      .content-section {
        grid-column: 1 / span 4;
        grid-row: 3 / span 2;
      }

      /* Total accredited & salaried */
      #totaltext {
        color: var(--color-primary-light);
        font-family: var(--font-display);
        font-size: 4.4vw;
        overflow-wrap: normal;
        vertical-align: middle;
        margin-top: .5rem;
        margin-bottom: .5rem;
        margin-right: .5rem;
        line-height: 1.1em;
      }

      #total-accredited-and-salaried {
        color: var(--color-background);
        font-family: var(--font-display);
        font-size: 4vw;
        text-align: center;
        vertical-align: middle;
        background-color: var(--color-secondary);
        margin: .5rem;
        padding: .5rem;
        border-radius: var(--radius-sm);
      }

      /* How to Use Dashboard button design */
      .how-to-use-button {
        place-self: center;
        background-color: var(--color-background);
        color: var(--color-black);
        font-family: var(--font-primary);
        vertical-align: middle;
        font-size: .45rem;
        font-weight: bold;
        text-transform: uppercase;
        border-radius: var(--radius-sm);
        border: 1px solid var(--color-black);
        padding-top: .25em;
        padding-bottom: .25em;
        padding-right: .5em;
        padding-left: .5em;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3em;
        margin: 0;
      }

      .play-icon {
        font-size: 0.8em;
      }

      .right a:link {
        text-decoration: none;
      }

      .right a:visited {
        text-decoration: none;
      }

      /* Map positioning */
      #map {
        grid-column: 1 / span 4;
        grid-row: 3 / span 1;
        height: 100%;
        position: relative;
      }

      /* Button design (map buttons) */
      .button {
        background-color: var(--color-background);
        color: var(--color-black);
        padding-top: .25em;
        padding-bottom: .25em;
        padding-right: .5em;
        padding-left: .5em;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-sm);
        font-family: var(--font-primary);
        font-size: .45rem;
        font-weight: bold;
        text-align: center;
        margin: 0;
        opacity: 0.8;
      }

      .button.active {
        background: var(--color-primary);
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        font-weight: bold;
        opacity: 1;
      }

      /* Download button design */
      .download-button {
        background-color: var(--color-background);
        color: var(--color-black);
        padding-top: .25em;
        padding-bottom: .25em;
        padding-right: .5em;
        padding-left: .5em;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-sm);
        font-family: var(--font-primary);
        font-size: .45rem;
        font-weight: bold;
        text-align: center;
        text-transform: uppercase;
        margin: 0;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 0 0 auto;
        white-space: nowrap;
      }

      .download-button:hover {
        background-color: var(--color-accent);
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        opacity: 1;
      }

      #buttoncontainer {
        position: absolute;
        top: 16%;
        left: 0;
        margin-left: .5em;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        max-width: calc(100vw - 1em);
        z-index: 1000;
        padding-top: clamp(0.3em, 0.2em + 0.2vw, 0.6em);
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
      }

      /* Search bar design */
      .searchcontainer {
        width: 60%;
        z-index: 1000;
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: .5em;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-sm);
        font-family: var(--font-primary);
        font-size: .49rem;
        background-color: var(--color-white);
        color: var(--color-black);
      }

      .search-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 3px rgba(79, 32, 73, 0.3);
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--color-white);
        border: 1px solid var(--color-black);
        border-top: none;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1001;
      }

      .search-result-item {
        cursor: pointer;
        font-family: var(--font-primary);
        font-size: .49rem;
        border-bottom: 1px solid var(--color-light-gray);
      }

      .search-result-item:hover {
        background-color: var(--color-accent);
        color: var(--color-background);
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      /* Legend and Download Container */
      .legend-and-download-container {
        position: absolute;
        bottom: 2em;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: flex-end;
        padding: 1em 1.5em 0.5em 1.5em;
        z-index: 1000;
        max-width: calc(100vw - 1em);
        /* On mobile, position relative to the map container */
        top: auto;
        height: auto;
      }

      /* Legend design */
      .legend {
        background: var(--color-white);
        border-radius: var(--radius-md);
        padding-top: .25em;
        padding-bottom: .25em;
        padding-left: .6em;
        padding-right: .6em;
        font-family: var(--font-primary);
        font-size: .45rem;
        box-shadow: var(--shadow-sm);
        flex: 0 1 auto;
        width: 280px;
        max-width: 60%;
      }

      #legend {
        box-shadow: var(--shadow-sm);
        line-height: 1.1em;
      }

      .legend-key {
        display: inline-block;
        border-radius: 20%;
        width: 10px;
        height: 10px;
        margin-right: 5px;
      }

      .legenditems {
        display: block;
      }

      h4 {
        margin-top: 5px;
        margin-bottom: 5px;
      }

      #legend-title {
        word-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
        line-height: 1.2;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        grid-column: 1 / span 4;
        grid-row: 4 / span 1;
        background-color: var(--color-background);
        color: var(--color-primary-light);
        padding: 1.5em 2.5em 2em 2.5em;
        font-size: .72rem;
        overflow-y: auto;
        max-height: 100%;
        font-family: var(--font-primary);
        border-top: solid 0.5px var(--color-primary-light);
      }


      #country-name {
        font-size: 1.16rem;
        text-transform: uppercase;
        font-family: var(--font-display);
        margin-bottom: 1em;
      }

      .out-of-scope-text {
        font-style: italic;
        font-family: var(--font-primary);
        font-size: .72rem;
        color: var(--color-primary-light);
        margin-bottom: 1em;
      }

      /* Button design (sidebar buttons) */
      .buttonsidebar {
        background-color: var(--color-background);
        color: var(--color-black);
        padding-top: .25em;
        padding-bottom: .25em;
        padding-right: .5em;
        padding-left: .5em;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-sm);
        font-family: var(--font-primary);
        font-size: .49rem;
        font-weight: bold;
        text-align: center;
        margin: 0;
        opacity: 1;
      }

      .buttonsidebar.active {
        background: var(--color-primary);
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        font-weight: bold;
        opacity: 1;
      }


      #download-link {
        margin-top: 1em;
      }

      #download-link a {
        color: var(--color-primary-light);
      }

      /* Bottom container of sidebar */
      #bottom {
        margin-top: auto;
        padding-top: 1em;
        line-height: 1.5em;
        font-size: .72rem;
        font-family: var(--font-primary);
      }


      #date-last-updated {
        font-style: italic;
      }

      /* CHW Cards design */
      .chw-cards-container {
        display: flex;
        flex-direction: row;
        gap: .5em;
        margin-bottom: 1em;
      }

      .chw-card {
        background-color: var(--color-primary);
        color: var(--color-background);
        border: none;
        border-radius: var(--radius-lg);
        padding: 1.2em 0.3em;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .chw-card:hover {
        background-color: var(--color-primary-light);
        color: var(--color-background);
      }

      .chw-card-number {
        font-family: var(--font-display);
        font-size: 1.16rem;
        font-weight: bold;
        margin-bottom: .2em;
      }

      .chw-card-number-not-available {
        font-family: var(--font-primary);
        font-style: italic;
        font-size: .49rem;
      }

      .chw-card-label {
        font-family: var(--font-primary);
        font-size: .49rem;
        font-weight: normal;
      }

      .chw-popups-container {
        margin-bottom: 1em;
      }

      .chw-popup {
        display: none;
        background-color: rgba(79, 32, 73, 0.08);
        border: none;
        border-radius: var(--radius-lg);
        padding: .5em;
        font-family: var(--font-primary);
        font-size: .49rem;
        width: 100%;
      }

      .chw-popup-title {
        font-weight: bold;
        color: var(--color-primary-light);
        margin: 0;
      }

      .chw-popup-list {
        list-style-type: disc;
        margin-left: 1em;
        padding-left: 0;
      }

      .chw-popup-list li {
        line-height: 1.4;
        margin: 0;
        color: var(--color-black);
      }

      /* Policy Status Card */
      .policy-status-card {
        background-color: var(--color-primary);
        color: var(--color-background);
        border: none;
        border-radius: var(--radius-lg);
        padding: 1.2em;
        margin-bottom: 1em;
        font-family: var(--font-primary);
        font-size: .49rem;
        line-height: 1.2;
        width: 100%;
      }

      .policy-status-header {
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
      }

      .policy-status-title {
        font-weight: bold;
        color: var(--color-background);
      }

      .policy-status-badge {
        padding: .2em .4em;
        border-radius: var(--radius-sm);
        font-weight: bold;
        font-size: .45rem;
        text-transform: uppercase;
      }

      .policy-status-badge.out-of-scope {
        background-color: var(--color-neutral);
        color: var(--color-background);
      }

      .policy-status-badge.data-not-available {
        background-color: var(--color-light-gray);
        color: var(--color-primary-light);
      }

      .policy-status-badge.expired,
      .policy-status-badge.expiring {
        background-color: var(--color-warning);
        color: var(--color-background);
      }

      .policy-status-badge.active {
        background-color: var(--color-secondary);
        color: var(--color-background);
      }

      .policy-status-content {
        font-size: .49rem;
        line-height: 1.2;
      }

      .policy-status-line {
        margin-bottom: .1em;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        width: 100%;
      }

      .policy-status-label {
        font-weight: bold;
        flex-shrink: 0;
        line-height: 1.8;
      }

      .policy-status-value {
        text-align: right;
        word-wrap: break-word;
        flex: 1;
        margin-left: 1em;
      }

      .policy-status-divider {
        height: 1px;
        background-color: rgba(244, 241, 235, 0.5);
        margin: .5em auto;
        width: 100%;
        display: block;
      }

      .policy-link {
        color: var(--color-background);
        text-decoration: none;
        font-weight: bold;
      }

      .policy-link:hover {
        text-decoration: underline;
      }

      /* Accreditation Section */
      .accreditation-section {
        background-color: transparent;
        border: none;
        border-radius: var(--radius-md);
        width: 100%;
      }

      .accreditation-section-header {
        background-color: transparent;
        border: none;
        border-radius: var(--radius-md);
        padding: .5em;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        width: 100%;
        margin-top: 2.5em;
      }

      .accreditation-section-header:hover {
        background-color: rgba(79, 32, 73, 0.1);
      }

      .accreditation-section-title {
        font-family: var(--font-display);
        font-size: .81rem;
        color: var(--color-primary-light);
        text-transform: uppercase;
        font-weight: bold;
        line-height: 1.2;
      }

      .accreditation-section-subtitle {
        font-family: 'Playfair Display', serif;
        font-size: .6rem;
        color: var(--color-black);
        font-style: normal;
        padding: .5em;
        line-height: 1.3;
      }

      .accreditation-section-arrow {
        color: var(--color-neutral);
        font-weight: bold;
        font-size: .72rem;
        margin-left: .5em;
        transition: transform 0.2s ease;
      }

      .accreditation-section.expanded .accreditation-section-arrow {
        transform: rotate(90deg);
      }

      .accreditation-section-content {
        padding: .8em;
        background-color: rgba(79, 32, 73, 0.08);
        border-radius: var(--radius-lg);
      }

      #policy-timeline-section .accreditation-section-content {
        background-color: transparent;
      }

      .accreditation-section-text {
        font-family: var(--font-primary);
        font-size: .49rem;
        color: var(--color-primary-light);
      }

      /* Accreditation Subsections */
      .accreditation-subsection {
        display: flex;
        align-items: center;
        padding-left: .5em;
        border-left: 3px solid var(--color-primary);
        margin-bottom: 1.2em;
      }

      .accreditation-subsection-content {
        flex: 1;
        margin-right: .5em;
      }

      .accreditation-subsection-title {
        font-family: var(--font-primary);
        font-size: .49rem;
        font-weight: bold;
        text-transform: uppercase;
        color: var(--color-primary-light);
        line-height: 1.2;
        padding: 0;
        margin-bottom: .3em;
      }

      .accreditation-subsection-description {
        font-family: var(--font-primary);
        font-size: .45rem;
        color: var(--color-black);
        line-height: 1.4;
      }

      .accreditation-subsection-indicator {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-left: .5em;
      }

      .indicator-circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: .3em;
        font-size: .45rem;
        font-weight: bold;
      }

      .indicator-circle.yes {
        background-color: var(--color-secondary);
        color: var(--color-light-gray);
      }

      .indicator-circle.no {
        background-color: var(--color-warning);
        color: var(--color-light-gray);
      }

      .indicator-circle.na {
        background-color: var(--color-neutral);
        color: var(--color-light-gray);
      }

      .indicator-text {
        font-family: var(--font-primary);
        font-size: .45rem;
        font-weight: bold;
        text-transform: uppercase;
        color: #666666;
      }

      .accreditation-subsection-source {
        font-family: var(--font-primary);
        font-size: .45rem;
        color: var(--color-black);
        margin-top: .3em;
        line-height: 1.4;
        font-style: italic;
      }

      .accreditation-subsection-source a {
        color: var(--color-primary-light);
        text-decoration: underline;
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
      }

      .accreditation-subsection-source a:hover {
        color: var(--color-primary);
      }

      /* Policy Timeline Styles */
      .policy-timeline {
        position: relative;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        padding: 0 .5em;
        margin: 1em 0;
      }

      /* The horizontal line */
      .policy-timeline::before {
        content: "";
        position: absolute;
        top: 12px; /* center of the dots */
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--color-primary);
        z-index: 0;
      }

      .timeline-item {
        position: relative;
        text-align: center;
        flex: 1 1 0;
      }

      /* The dot */
      .timeline-item::before {
        content: "";
        position: absolute;
        top: 8px; /* align with the line */
        left: 50%;
        transform: translateX(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--color-primary);
        border: 1px solid var(--color-light-gray);
        z-index: 1;
      }

      .timeline-year {
        font-family: 'Anton', sans-serif;
        font-size: .7rem;
        color: var(--color-primary);
        margin-top: 2.2em;
        margin-bottom: .3em;
        text-align: center;
      }

      .timeline-milestone {
        font-family: var(--font-primary);
        font-size: .45rem;
        color: var(--color-primary-light);
        text-align: center;
        line-height: 1.4;
        max-width: 120px;
        margin: 0 auto;
      }

      .timeline-milestone a {
        color: var(--color-primary-light);
        text-decoration: underline;
      }

      .timeline-milestone a:hover {
        color: var(--color-primary);
      }

      /* AI Summary Card Styles */
      .ai-summary-card {
        background-color: var(--color-accent);
        border-radius: var(--radius-lg);
        padding: 1.5em;
        margin-top: 2.5em;
        font-family: 'Helvetica Neue', Arial, sans-serif;
      }

      .ai-summary-title {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        font-size: .81rem;
        color: var(--color-black);
        text-transform: uppercase;
        font-weight: bold;
        line-height: 1.2;
        margin-bottom: 1em;
      }

      .ai-summary-content {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        font-size: .9rem;
        color: var(--color-black);
        line-height: 1.2;
      }

      /* Button hover (definition) design - Hidden on mobile */
      .buttondefcontainer {
        display: none;
      }

      /* Hide all tooltips on mobile */
      .accredited-chws-button-def,
      .salaried-chws-button-def,
      .accredited-and-salaried-chws-button-def,
      .policy-status-button-def,
      .implementation-evidence-button-def {
        display: none;
      }

      /* Popup styles */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      .popup-content {
        background-color: var(--color-background);
        border-radius: var(--radius-md);
        padding: 1.5em;
        max-width: 500px;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        margin-bottom: 1em;
        padding-bottom: 0.5em;
      }

      .popup-header h3 {
        margin: 0;
        font-family: var(--font-display);
        color: var(--color-primary-light);
        font-size: 1.16rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 1.35rem;
        color: var(--color-primary);
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease;
        outline: none;
        box-shadow: none;
      }

      .close-button:hover {
        color: var(--color-primary-light);
        background: none;
        outline: none;
        box-shadow: none;
      }

      .close-button:focus,
      .close-button:focus-visible,
      .close-button:active {
        outline: none;
        box-shadow: none;
        background: none;
        border: none;
      }

      .popup-body {
        font-family: var(--font-primary);
        color: var(--color-black);
        line-height: 1.3;
        font-size: 0.75rem;
      }

    }

    /* Laptop */
    @media screen and (min-width: 768px) {

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0px;
        padding: 0px;
        background-color: var(--color-background);
        height: 100%;
      }

      .container {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        grid-template-rows: 20vh 80vh;
        height: 100%;
      }

      /* Container for header elements */
      .header {
        grid-column: 1 / span 12;
        display: grid;
      }

      .header-section {
        grid-row: 1;
        display: grid;
        align-items: center;
      }

      /* Child containers within header */
      .left {
        grid-column: 1 / span 2;
      }

      .middle {
        grid-column: 3 / span 6;
      }

      .right {
        grid-column: 9 / span 3;
      }

      /* Define map and sidebar container */
      .content-section {
        grid-row: 2;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        grid-column: 9 / span 4;
        background-color: var(--color-background);
        color: var(--color-primary-light);
        padding: 1em 1.5em 0.5em 1.5em;
        border-top: solid 1px var(--color-primary-light);
        border-left: solid 1px var(--color-primary-light);
        overflow-y: auto;
        max-height: 100%;
      }

      /* How to Use Dashboard button design */
      .how-to-use-button {
        text-align: center;
        background-color: var(--color-background);
        color: var(--color-black);
        font-family: var(--font-primary);
        text-align: center;
        vertical-align: middle;
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-transform: uppercase;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-black);
        padding: 10px;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: .5em;
        padding-bottom: .5em;
        margin: 1em;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
      }

      .play-icon {
        font-size: 0.8em;
      }

      .right a:link {
        text-decoration: none;
      }

      .right a:visited {
        text-decoration: none;
      }

      /* Total accredited & salaried */
      #totaltext {
        color: var(--color-primary-light);
        font-family: var(--font-display);
        font-size: clamp(1.8rem, 1.046rem + 1.571vw, 2.46rem);
        overflow-wrap: normal;
        vertical-align: middle;
        margin-top: 0.3em;
        margin-bottom: 0.3em;
        margin-right: 0.3em;
        line-height: 1.1em;

      }

      #total-accredited-and-salaried {
        color: var(--color-background);
        font-family: var(--font-display);
        font-size: clamp(2rem, 1.2rem + 1.667vw, 2.7rem);
        text-align: center;
        vertical-align: middle;
        background-color: var(--color-secondary);
        margin: 0.3em;
        padding: 0.3em;
        border-radius: var(--radius-md);
      }

      /* Map positioning */
      #map {
        grid-column: 1 / span 8;
        height: 100%;
        position: relative;
      }

      /* Legend and Download Container */
      .legend-and-download-container {
        position: absolute;
        bottom: 2em;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: flex-end;
        padding: 1em 1.5em 0.5em 1.5em;
        z-index: 1000;
        max-width: calc(66.67vw - 0.5em);
      }

      /* Legend design */
      .legend {
        background: #fff;
        border-radius: var(--radius-md);
        padding: .8em;
        font-family: 'Helvetica Neue', 'Arial Narrow', Sans-serif;
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        flex: 0 1 auto;
        width: 280px;
        max-width: 60%;
      }

      #legend {
        line-height: 1.3em;
        margin-bottom: 0;
      }

      /* Download button design */
      .download-button {
        background-color: var(--color-background);
        color: var(--color-black);
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        padding: 10px;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: .5em;
        padding-bottom: .5em;
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-align: center;
        text-transform: uppercase;
        margin: 0;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 0 0 auto;
        white-space: nowrap;
      }

      .download-button:hover {
        background-color: var(--color-accent);
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        opacity: 1;
      }

      .legend-key {
        display: inline-block;
        border-radius: 20%;
        width: 10px;
        height: 10px;
        margin-right: 5px;
      }

      .legenditems {
        display: inline-block;
      }

      h4 {
        margin-top: 5px;
        margin-bottom: 5px;
      }

      #legend-title {
        word-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
        line-height: 1.2;
      }

      /* Popup design */
      .mapboxgl-popup-content {
        font-family: 'Helvetica Neue', 'Arial Narrow', Sans-serif;
        opacity: 0.8;
        background-color: var(--color-black);
        color: var(--color-background);
      }

      /* Sidebar design */
      #country-name {
        font-size: clamp(1.2rem, 0.6rem + 1.8vw, 3rem);
        text-transform: uppercase;
        font-family: var(--font-display);
        line-height: 1.1em;
        margin-bottom: 1em;
      }

      .out-of-scope-text {
        font-style: italic;
        font-family: var(--font-primary);
        font-size: clamp(0.54rem, 0.36rem + 0.45vw, 0.81rem);
        color: var(--color-primary-light);
        margin-bottom: 1em;
      }


      #download-link {
        margin-top: 1em;
      }

      #download-link a {
        color: var(--color-primary-light);
      }

      /* Button design (sidebar buttons) */
      .buttonsidebar {
        background-color: var(--color-background);
        color: var(--color-black);
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        font-family: var(--font-primary);
        white-space: normal;
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-align: center;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: 1em;
        padding-bottom: 1em;
        opacity: 1;
      }

      buttonsidebar:hover {
        background: #4F2049;
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        font-weight: bold;
        opacity: 1;
      }

      /* Bottom container of sidebar */
      .bottom {
        margin-top: auto;
        padding-top: 1em;
        line-height: 1.3em;
        font-family: var(--font-primary);
        font-size: clamp(0.54rem, 0.36rem + 0.45vw, 0.81rem);
      }


      #date-last-updated {
        font-style: italic;
      }

      /* CHW Cards design */
      .chw-cards-container {
        display: flex;
        flex-direction: row;
        gap: .5em;
        flex-wrap: wrap;
        margin-bottom: 1em;
      }

      .chw-card {
        background-color: var(--color-primary);
        color: var(--color-background);
        border: none;
        border-radius: var(--radius-lg);
        padding: 1.2em 0.3em;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .chw-card:hover {
        background-color: var(--color-primary-light);
        color: var(--color-background);
      }

      .chw-card-number {
        font-family: var(--font-display);
        font-size: clamp(0.9rem, 0.72rem + 0.45vw, 1.35rem);
        font-weight: bold;
        margin-bottom: .3em;
      }

      .chw-card-number-not-available {
        font-family: var(--font-primary);
        font-style: italic;
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
      }

      .chw-card-label {
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: normal;
      }

      .chw-popups-container {
        margin-bottom: 1em;
      }

      .chw-popup {
        display: none;
        background-color: rgba(79, 32, 73, 0.08);
        border: none;
        border-radius: var(--radius-lg);
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        line-height: 1.2;
        width: 100%;
      }

      .chw-popup-title {
        font-weight: bold;
        color: var(--color-primary-light);
        margin: 0;
      }

      .chw-popup-list {
        list-style-type: disc;
        margin-left: 1em;
        padding-left: 0;
      }

      .chw-popup-list li {
        line-height: 1.4;
        margin: 0;
        color: var(--color-black);
      }


      /* Map button design */
      .button {
        background-color: var(--color-background);
        color: var(--color-black);
        padding: 10px;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-align: center;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: .5em;
        padding-bottom: .5em;
        margin: 0;
        opacity: 0.8;
      }

      .button.active {
        background: #4F2049;
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        font-weight: bold;
        opacity: 1;
      }

      /* Policy Status Card */
      .policy-status-card {
        background-color: var(--color-primary);
        color: var(--color-background);
        border: none;
        border-radius: var(--radius-lg);
        padding: 1.2em;
        margin-bottom: 1em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        line-height: 1.2;
        width: 100%;
      }

      .policy-status-header {
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
      }

      .policy-status-title {
        font-weight: bold;
        color: var(--color-background);
      }

      .policy-status-badge {
        padding: .3em .6em;
        border-radius: var(--radius-md);
        font-weight: bold;
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        text-transform: uppercase;
      }

      .policy-status-badge.out-of-scope {
        background-color: var(--color-neutral);
        color: var(--color-background);
      }

      .policy-status-badge.data-not-available {
        background-color: var(--color-light-gray);
        color: var(--color-primary-light);
      }

      .policy-status-badge.expired,
      .policy-status-badge.expiring {
        background-color: var(--color-warning);
        color: var(--color-background);
      }

      .policy-status-badge.active {
        background-color: var(--color-secondary);
        color: var(--color-background);
      }

      .policy-status-content {
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        line-height: 1.2;
      }

      .policy-status-line {
        margin-bottom: .1em;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        width: 100%;
      }

      .policy-status-label {
        font-weight: bold;
        flex-shrink: 0;
        line-height: 1.8;
      }

      .policy-status-value {
        text-align: right;
        word-wrap: break-word;
        flex: 1;
        margin-left: 1em;
      }

      .policy-status-divider {
        height: 1px;
        background-color: rgba(244, 241, 235, 0.5);
        margin: .5em auto;
        width: 100%;
        display: block;
      }

      .policy-link {
        color: var(--color-background);
        text-decoration: none;
        font-weight: bold;
      }

      .policy-link:hover {
        text-decoration: underline;
      }

      /* Accreditation Section */
      .accreditation-section {
        background-color: transparent;
        border: none;
        border-radius: var(--radius-md);
        width: 100%;
      }

      .accreditation-section-header {
        background-color: transparent;
        border: none;
        border-radius: var(--radius-md);
        padding: .5em;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        width: 100%;
        margin-top: 2.5em;
      }

      .accreditation-section-header:hover {
        background-color: rgba(79, 32, 73, 0.1);
      }

      .accreditation-section-title {
        font-family: var(--font-display);
        font-size: clamp(0.63rem, 0.36rem + 0.9vw, 1.62rem);
        color: var(--color-primary-light);
        text-transform: uppercase;
        font-weight: bold;
        line-height: 1.2;
      }

      .accreditation-section-subtitle {
        font-family: 'Playfair Display', serif;
        font-size: clamp(0.55rem, 0.4rem + 0.55vw, 0.95rem);
        color: var(--color-black);
        font-style: normal;
        padding: .5em;
        line-height: 1.3;
      }

      .accreditation-section-arrow {
        color: var(--color-neutral);
        font-weight: bold;
        font-size: .72rem;
        margin-left: .5em;
        transition: transform 0.2s ease;
      }

      .accreditation-section.expanded .accreditation-section-arrow {
        transform: rotate(90deg);
      }

      .accreditation-section-content {
        padding: .8em;
        background-color: rgba(79, 32, 73, 0.08);
        border-radius: var(--radius-lg);
      }

      #policy-timeline-section .accreditation-section-content {
        background-color: transparent;
      }

      .accreditation-section-text {
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        color: var(--color-primary-light);
      }

      /* Accreditation Subsections */
      .accreditation-subsection {
        display: flex;
        align-items: center;
        padding-left: .8em;
        border-left: 3px solid var(--color-primary);
        margin-bottom: 1.2em;
      }

      .accreditation-subsection-content {
        flex: 1;
        margin-right: .8em;
      }

      .accreditation-subsection-title {
        padding: 0;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-transform: uppercase;
        color: var(--color-primary-light);
        line-height: 1.2;
        margin-bottom: .4em;
      }

      .accreditation-subsection-description {
        font-family: var(--font-primary);
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        color: var(--color-black);
        line-height: 1.4;
      }

      .accreditation-subsection-indicator {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-left: .8em;
      }

      .indicator-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: .4em;
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        font-weight: bold;
      }

      .indicator-circle.yes {
        background-color: var(--color-secondary);
        color: var(--color-light-gray);
      }

      .indicator-circle.no {
        background-color: var(--color-warning);
        color: var(--color-light-gray);
      }

      .indicator-circle.na {
        background-color: var(--color-neutral);
        color: var(--color-light-gray);
      }

      .indicator-text {
        font-family: var(--font-primary);
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        font-weight: bold;
        text-transform: uppercase;
        color: #666666;
      }

      .accreditation-subsection-source {
        font-family: var(--font-primary);
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        color: var(--color-black);
        margin-top: .4em;
        line-height: 1.4;
        font-style: italic;
      }

      .accreditation-subsection-source a {
        color: var(--color-primary-light);
        text-decoration: underline;
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
      }

      .accreditation-subsection-source a:hover {
        color: var(--color-primary);
      }

      /* Policy Timeline Styles - Laptop */
      .policy-timeline {
        position: relative;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        padding: 0 .8em;
        margin: 1.2em 0;
      }

      /* The horizontal line */
      .policy-timeline::before {
        content: "";
        position: absolute;
        top: 14px; /* center of the dots */
        left: 0;
        right: 0;
        height: 3px;
        background-color: var(--color-primary);
        z-index: 0;
      }

      .timeline-item {
        position: relative;
        text-align: center;
        flex: 1 1 0;
      }

      /* The dot */
      .timeline-item::before {
        content: "";
        position: absolute;
        top: 9px; /* align with the line */
        left: 50%;
        transform: translateX(-50%);
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--color-primary);
        border: 2px solid var(--color-light-gray);
        z-index: 1;
      }

      .timeline-year {
        font-family: 'Anton', sans-serif;
        font-size: .72rem;
        color: var(--color-primary);
        margin-top: 2.5em;
        margin-bottom: .4em;
        text-align: center;
      }

      .timeline-milestone {
        font-family: var(--font-primary);
        font-size: .49rem;
        color: var(--color-primary-light);
        text-align: center;
        line-height: 1.4;
        max-width: 150px;
        margin: 0 auto;
      }

      .timeline-milestone a {
        color: var(--color-primary-light);
        text-decoration: underline;
      }

      .timeline-milestone a:hover {
        color: var(--color-primary);
      }

      /* AI Summary Card Styles - Laptop */
      .ai-summary-card {
        background-color: var(--color-accent);
        border-radius: var(--radius-lg);
        padding: 1.5em;
        margin-top: 2.5em;
        font-family: 'Helvetica Neue', Arial, sans-serif;
      }

      .ai-summary-title {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        font-size: .81rem;
        color: var(--color-black);
        text-transform: uppercase;
        font-weight: bold;
        line-height: 1.2;
        margin-bottom: 1em;
      }

      .ai-summary-content {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        font-size: .9rem;
        color: var(--color-black);
        line-height: 1.2;
      }

      .buttoncontainer {
        position: absolute;
        top: 22%;
        left: 0;
        margin-left: 10px;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        max-width: calc(66.67vw - 20px);
        z-index: 1000;
        padding-top: clamp(0.3em, 0.2em + 0.2vw, 0.6em);
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
      }

      /* Search bar design */
      .searchcontainer {
        width: 300px;
        z-index: 1000;
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: .8em;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        background-color: var(--color-white);
        /* background-color: #F4F1EB; */
        color: var(--color-black);
      }

      .search-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 5px rgba(79, 32, 73, 0.3);
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--color-white);
        border: 1px solid var(--color-black);
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        z-index: 1001;
      }

      .search-result-item {
        cursor: pointer;
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        border-bottom: 1px solid var(--color-light-gray);
      }

      .search-result-item:hover {
        background-color: var(--color-accent);
        color: var(--color-background);
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      button:not(.close-button):hover {
        background: #4F2049;
        color: var(--color-background);
        font-weight: bold;
        border: 1px solid var(--color-primary);
      }

      /* Button hover (definition) design - Individual button positioning */
      .button-with-tooltip {
        position: relative;
        display: inline-block;
      }

      .accredited-chws-button-def,
      .salaried-chws-button-def,
      .accredited-and-salaried-chws-button-def,
      .policy-status-button-def,
      .implementation-evidence-button-def {
        display: none;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 8px;
        max-width: 280px;
        min-width: 180px;
        font-family: 'Helvetica Neue', 'Arial Narrow', Sans-serif;
        font-size: 0.8rem;
        line-height: 1.4;
        background-color: var(--color-black);
        color: var(--color-background);
        padding: 10px 14px;
        border-radius: 6px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        opacity: 1;
        z-index: 2001;
        pointer-events: none;
      }

      /* Tooltip arrow */
      .accredited-chws-button-def::after,
      .salaried-chws-button-def::after,
      .accredited-and-salaried-chws-button-def::after,
      .policy-status-button-def::after,
      .implementation-evidence-button-def::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-bottom-color: var(--color-black);
      }

      /* Popup styles */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      .popup-content {
        background-color: var(--color-background);
        border-radius: var(--radius-md);
        padding: 2em;
        max-width: 600px;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        margin-bottom: 1em;
        padding-bottom: 0.5em;
      }

      .popup-header h3 {
        margin: 0;
        font-family: var(--font-display);
        color: var(--color-primary-light);
        font-size: 1.35rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 1.62rem;
        color: var(--color-primary);
        cursor: pointer;
        padding: 0;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease;
        outline: none;
        box-shadow: none;
      }

      .close-button:hover {
        color: var(--color-primary-light);
        background: none;
        outline: none;
        box-shadow: none;
      }

      .close-button:focus,
      .close-button:focus-visible,
      .close-button:active {
        outline: none;
        box-shadow: none;
        background: none;
        border: none;
      }

      .popup-body {
        font-family: var(--font-primary);
        color: var(--color-black);
        line-height: 1.4;
        font-size: 0.85rem;
      }

    }

    /* Desktop */
    @media screen and (min-width: 1280px) and (min-height: 570px) {

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0px;
        padding: 0px;
        background-color: var(--color-background);
        height: 100%;
      }

      .container {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        grid-template-rows: 20vh 80vh;
        height: 100%;
      }

      /* Container for header elements */
      .header {
        grid-column: 1 / span 12;
        display: grid;
        align-items: center;
      }

      .header-section {
        grid-row: 1;
      }

      /* Child containers within header */
      .left {
        grid-column: 1 / span 2;
      }

      .middle {
        grid-column: 3 / span 6;
      }

      .right {
        grid-column: 9 / span 3;
      }

      /* Define map and sidebar container */
      .content-section {
        grid-row: 2;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        grid-column: 9 / span 4;
        background-color: var(--color-background);
        color: var(--color-primary-light);
        padding: 1em 1.5em 0.5em 1.5em;
        border-top: solid 1px var(--color-primary-light);
        border-left: solid 1px var(--color-primary-light);
        overflow-y: auto;
        max-height: 100%;
      }

      /* How to Use Dashboard button design */
      .how-to-use-button {
        text-align: center;
        background-color: var(--color-background);
        color: var(--color-black);
        font-family: var(--font-primary);
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        text-transform: uppercase;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-black);
        padding: 10px;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: .5em;
        padding-bottom: .5em;
        margin: 1em;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
      }

      .play-icon {
        font-size: 0.8em;
      }

      .right a:link {
        text-decoration: none;
      }

      .right a:visited {
        text-decoration: none;
      }

      /* Total accredited & salaried */
      #totaltext {
        color: var(--color-primary-light);
        font-family: var(--font-display);
        font-size: clamp(2.4rem, 1.2rem + 1.667vw, 3.8rem);
        vertical-align: middle;
        margin-top: 0.3em;
        margin-bottom: 0.3em;
        margin-right: 0.3em;
        line-height: 1.1em;

      }

      #total-accredited-and-salaried {
        color: var(--color-background);
        font-family: var(--font-display);
        font-size: clamp(2.4rem, 1.2rem + 1.667vw, 4rem);
        text-align: center;
        vertical-align: middle;
        background-color: var(--color-secondary);
        margin: 0.3em;
        padding: 0.3em;
        border-radius: var(--radius-md);
      }

      /* Map positioning */
      #map {
        grid-column: 1 / span 8;
        height: 100%;
        position: relative;
      }

      /* Legend and Download Container */
      .legend-and-download-container {
        position: absolute;
        bottom: 2em;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: flex-end;
        padding: 1em 1.5em 0.5em 1.5em;
        z-index: 1000;
        max-width: calc(66.67vw - 0.5em);
      }

      /* Legend design */
      .legend {
        background: #fff;
        border-radius: var(--radius-md);
        padding: .8em;
        font-family: 'Helvetica Neue', 'Arial Narrow', Sans-serif;
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        flex: 0 1 auto;
        width: 280px;
        max-width: 60%;
      }

      #legend {
        line-height: 1.3em;
        margin-bottom: 0;
      }

      /* Download button design */
      .download-button {
        background-color: var(--color-background);
        color: var(--color-black);
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        padding: 10px;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: .5em;
        padding-bottom: .5em;
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-align: center;
        text-transform: uppercase;
        margin: 0;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 0 0 auto;
        white-space: nowrap;
      }

      .download-button:hover {
        background-color: var(--color-accent);
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        opacity: 1;
      }

      .legend-key {
        display: inline-block;
        border-radius: 20%;
        width: 10px;
        height: 10px;
        margin-right: 5px;
      }

      .legenditems {
        display: inline-block;
      }

      h4 {
        margin-top: 5px;
        margin-bottom: 5px;
      }

      #legend-title {
        word-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
        line-height: 1.2;
      }

      /* Popup design */
      .mapboxgl-popup-content {
        font-family: 'Helvetica Neue', 'Arial Narrow', Sans-serif;
        opacity: 0.8;
        background-color: var(--color-black);
        color: var(--color-background);
      }

      /* Sidebar design */
      #country-name {
        font-size: clamp(1.2rem, 0.6rem + 1.8vw, 3rem);
        text-transform: uppercase;
        font-family: var(--font-display);
        line-height: 1.1em;
        margin-bottom: 1em;
      }

      .out-of-scope-text {
        font-style: italic;
        font-family: var(--font-primary);
        font-size: clamp(0.63rem, 0.54rem + 0.27vw, 0.9rem);
        color: var(--color-primary-light);
        margin-bottom: 1em;
      }


      #download-link {
        margin-top: 1em;
      }

      #download-link a {
        color: var(--color-primary-light);
      }

      /* Button design (sidebar buttons) */
      .buttonsidebar {
        background-color: var(--color-background);
        color: var(--color-black);
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-align: center;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: 1em;
        padding-bottom: 1em;
        opacity: 1;
      }

      buttonsidebar:hover {
        background: #4F2049;
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        font-weight: bold;
        opacity: 1;
      }

      /* Bottom container of sidebar */
      .bottom {
        margin-top: auto;
        padding-top: 1em;
        line-height: 1.3em;
        font-family: var(--font-primary);
        font-size: clamp(0.7rem, 0.6rem + 0.2vw, 1rem);
      }


      #date-last-updated {
        font-style: italic;
      }

      /* CHW Cards design */
      .chw-cards-container {
        display: flex;
        flex-direction: row;
        gap: .5em;
        flex-wrap: wrap;
        margin-bottom: 1em;
      }

      .chw-card {
        background-color: var(--color-primary);
        color: var(--color-background);
        border: none;
        border-radius: var(--radius-lg);
        padding: 1.2em 0.3em;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .chw-card:hover {
        background-color: var(--color-primary-light);
        color: var(--color-background);
      }

      .chw-card-number {
        font-family: var(--font-display);
        font-size: clamp(1.08rem, 0.9rem + 0.45vw, 1.62rem);
        font-weight: bold;
        margin-bottom: .3em;
      }

      .chw-card-number-not-available {
        font-family: var(--font-primary);
        font-style: italic;
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
      }

      .chw-card-label {
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: normal;
      }

      .chw-popups-container {
        margin-bottom: 1em;
      }

      .chw-popup {
        display: none;
        background-color: rgba(79, 32, 73, 0.08);
        border: none;
        border-radius: var(--radius-lg);
        padding: 1em 1.5em 0.5em 1.5em;
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        line-height: 1.2;
        width: 100%;
      }

      .chw-popup-title {
        font-weight: bold;
        color: var(--color-primary-light);
        margin: 0;
      }

      .chw-popup-list {
        list-style-type: disc;
        margin-left: 1em;
        padding-left: 0;
      }

      .chw-popup-list li {
        line-height: 1.4;
        margin: 0;
        color: var(--color-black);
      }


      /* Map button design */
      .button {
        background-color: var(--color-background);
        color: var(--color-black);
        padding: 10px;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-align: center;
        padding-right: 1em;
        padding-left: 1em;
        padding-top: .5em;
        padding-bottom: .5em;
        margin: 0;
        opacity: 0.8;
      }

      .button.active {
        background: #4F2049;
        color: var(--color-background);
        border: 1px solid var(--color-primary);
        font-weight: bold;
        opacity: 1;
      }

      /* Policy Status Card */
      .policy-status-card {
        background-color: var(--color-primary);
        color: var(--color-background);
        border: none;
        border-radius: var(--radius-lg);
        padding: 1.2em;
        margin-bottom: 1em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        line-height: 1.2;
        width: 100%;
      }

      .policy-status-header {
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
      }

      .policy-status-title {
        font-weight: bold;
        color: var(--color-background);
      }

      .policy-status-badge {
        padding: .3em .6em;
        border-radius: var(--radius-md);
        font-weight: bold;
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        text-transform: uppercase;
      }

      .policy-status-badge.out-of-scope {
        background-color: var(--color-neutral);
        color: var(--color-background);
      }

      .policy-status-badge.data-not-available {
        background-color: var(--color-light-gray);
        color: var(--color-primary-light);
      }

      .policy-status-badge.expired,
      .policy-status-badge.expiring {
        background-color: var(--color-warning);
        color: var(--color-background);
      }

      .policy-status-badge.active {
        background-color: var(--color-secondary);
        color: var(--color-background);
      }

      .policy-status-content {
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        line-height: 1.2;
      }

      .policy-status-line {
        margin-bottom: .1em;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        width: 100%;
      }

      .policy-status-label {
        font-weight: bold;
        flex-shrink: 0;
        line-height: 1.8;
      }

      .policy-status-value {
        text-align: right;
        word-wrap: break-word;
        flex: 1;
        margin-left: 1em;
      }

      .policy-status-divider {
        height: 1px;
        background-color: rgba(244, 241, 235, 0.5);
        margin: .5em auto;
        width: 100%;
        display: block;
      }

      .policy-link {
        color: var(--color-background);
        text-decoration: none;
        font-weight: bold;
      }

      .policy-link:hover {
        text-decoration: underline;
      }

      /* Accreditation Section */
      .accreditation-section {
        background-color: transparent;
        border: none;
        border-radius: var(--radius-lg);
        width: 100%;
      }

      .accreditation-section-header {
        background-color: transparent;
        border: none;
        border-radius: var(--radius-lg);
        padding: .5em;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: cent;
        margin-top: 2.5em;
      }

      .accreditation-section-header:hover {
        background-color: rgba(79, 32, 73, 0.1);
      }

      .accreditation-section-title {
        font-family: var(--font-display);
        font-size: clamp(0.63rem, 0.36rem + 0.9vw, 1.62rem);
        color: var(--color-primary-light);
        text-transform: uppercase;
        font-weight: bold;
        line-height: 1.2;
      }

      .accreditation-section-subtitle {
        font-family: 'Playfair Display', serif;
        font-size: clamp(0.55rem, 0.4rem + 0.55vw, 0.95rem);
        color: var(--color-black);
        font-style: normal;
        padding: .5em;
        line-height: 1.3;
      }

      .accreditation-section-arrow {
        color: var(--color-neutral);
        font-weight: bold;
        font-size: .72rem;
        margin-left: .5em;
        transition: transform 0.2s ease;
      }

      .accreditation-section.expanded .accreditation-section-arrow {
        transform: rotate(90deg);
      }

      .accreditation-section-content {
        padding: .8em;
        background-color: rgba(79, 32, 73, 0.08);
        border-radius: var(--radius-lg);
      }

      #policy-timeline-section .accreditation-section-content {
        background-color: transparent;
      }

      .accreditation-section-text {
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        color: var(--color-primary-light);
      }

      /* Accreditation Subsections */
      .accreditation-subsection {
        display: flex;
        align-items: center;
        padding-left: .8em;
        border-left: 3px solid var(--color-primary);
        margin-bottom: 1.2em;
      }

      .accreditation-subsection-content {
        flex: 1;
        margin-right: .8em;
      }

      .accreditation-subsection-title {
        padding: 0;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        font-weight: bold;
        text-transform: uppercase;
        color: var(--color-primary-light);
        line-height: 1.2;
        margin-bottom: .4em;
      }

      .accreditation-subsection-description {
        font-family: var(--font-primary);
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        color: var(--color-black);
        line-height: 1.4;
      }

      .accreditation-subsection-indicator {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-left: .8em;
      }

      .indicator-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: .4em;
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        font-weight: bold;
      }

      .indicator-circle.yes {
        background-color: var(--color-secondary);
        color: var(--color-light-gray);
      }

      .indicator-circle.no {
        background-color: var(--color-warning);
        color: var(--color-light-gray);
      }

      .indicator-circle.na {
        background-color: var(--color-neutral);
        color: var(--color-light-gray);
      }

      .indicator-text {
        font-family: var(--font-primary);
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        font-weight: bold;
        text-transform: uppercase;
        color: #666666;
      }

      .accreditation-subsection-source {
        font-family: var(--font-primary);
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
        color: var(--color-black);
        margin-top: .4em;
        line-height: 1.4;
      }

      .accreditation-subsection-source a {
        color: var(--color-primary-light);
        text-decoration: underline;
        font-size: clamp(0.45rem, 0.36rem + 0.36vw, 0.81rem);
      }

      .accreditation-subsection-source a:hover {
        color: var(--color-primary);
      }

      /* Policy Timeline Styles - Desktop */
      .policy-timeline {
        position: relative;
        display: flex;
        justify-content: space-between;
        gap: 2em;
        padding: 0 1em;
        margin: 1.5em 0;
      }

      /* The horizontal line */
      .policy-timeline::before {
        content: "";
        position: absolute;
        top: 16px; /* center of the dots */
        left: 0;
        right: 0;
        height: 4px;
        background-color: var(--color-primary);
        z-index: 0;
      }

      .timeline-item {
        position: relative;
        text-align: center;
        flex: 1 1 0;
      }

      /* The dot */
      .timeline-item::before {
        content: "";
        position: absolute;
        top: 10px; /* align with the line */
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--color-primary);
        border: 2px solid var(--color-light-gray);
        z-index: 1;
      }

      .timeline-year {
        font-family: 'Anton', sans-serif;
        font-size: .81rem;
        color: var(--color-primary);
        margin-top: 2.8em;
        margin-bottom: .5em;
        text-align: center;
      }

      .timeline-milestone {
        font-family: var(--font-primary);
        font-size: .7rem;
        color: var(--color-primary-light);
        text-align: center;
        line-height: 1.2;
        max-width: 180px;
        margin: 0 auto;
      }

      .timeline-milestone a {
        color: var(--color-primary-light);
        text-decoration: underline;
      }

      .timeline-milestone a:hover {
        color: var(--color-primary);
      }

      /* AI Summary Card Styles - Desktop */
      .ai-summary-card {
        background-color: var(--color-accent);
        border-radius: var(--radius-lg);
        padding: 1.5em;
        margin-top: 2.5em;
        font-family: 'Helvetica Neue', Arial, sans-serif;
      }

      .ai-summary-title {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        font-size: .81rem;
        color: var(--color-black);
        text-transform: uppercase;
        font-weight: bold;
        line-height: 1.2;
        margin-bottom: 1em;
      }

      .ai-summary-content {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        font-size: .9rem;
        color: var(--color-black);
        line-height: 1.2;
      }

      .buttoncontainer {
        position: absolute;
        top: 20%;
        left: 0;
        margin-left: 10px;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        max-width: calc(66.67vw - 20px);
        z-index: 1000;
        padding-top: clamp(0.3em, 0.2em + 0.2vw, 0.6em);
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
      }

      /* Search bar design */
      .searchcontainer {
        width: 350px;
        z-index: 1000;
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: 0.75em 1.5em;
        border: 1px solid var(--color-black);
        border-radius: var(--radius-md);
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        background-color: var(--color-white);
        color: var(--color-black);
      }

      .search-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 5px rgba(79, 32, 73, 0.3);
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--color-white);
        border: 1px solid var(--color-black);
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 1001;
      }

      .search-result-item {
        cursor: pointer;
        padding: .8em;
        font-family: var(--font-primary);
        font-size: clamp(0.41rem, 0.32rem + 0.41vw, 0.81rem);
        border-bottom: 1px solid var(--color-light-gray);
      }

      .search-result-item:hover {
        background-color: var(--color-accent);
        color: var(--color-background);
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      button:not(.close-button):hover {
        background: #4F2049;
        color: var(--color-background);
        font-weight: bold;
        border: 1px solid var(--color-primary);
      }

      /* Button hover (definition) design - Individual button positioning */
      .button-with-tooltip {
        position: relative;
        display: inline-block;
      }

      .accredited-chws-button-def,
      .salaried-chws-button-def,
      .accredited-and-salaried-chws-button-def,
      .policy-status-button-def,
      .implementation-evidence-button-def {
        display: none;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 8px;
        max-width: 300px;
        min-width: 200px;
        font-family: 'Helvetica Neue', 'Arial Narrow', Sans-serif;
        font-size: 0.85rem;
        line-height: 1.4;
        background-color: var(--color-black);
        color: var(--color-background);
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 1;
        z-index: 2001;
        pointer-events: none;
      }

      /* Tooltip arrow */
      .accredited-chws-button-def::after,
      .salaried-chws-button-def::after,
      .accredited-and-salaried-chws-button-def::after,
      .policy-status-button-def::after,
      .implementation-evidence-button-def::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-bottom-color: var(--color-black);
      }

      /* Popup styles */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      .popup-content {
        background-color: var(--color-background);
        border-radius: var(--radius-md);
        padding: 2.5em;
        max-width: 700px;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        gap: 2em;
        align-items: center;
        margin-bottom: 1em;
        padding-bottom: 0.5em;
      }

      .popup-header h3 {
        margin: 0;
        font-family: var(--font-display);
        color: var(--color-primary-light);
        font-size: 1.62rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 2rem;
        color: var(--color-primary);
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease;
        outline: none;
        box-shadow: none;
      }

      .close-button:hover {
        color: var(--color-primary-light);
        background: none;
        outline: none;
        box-shadow: none;
      }

      .close-button:focus,
      .close-button:focus-visible,
      .close-button:active {
        outline: none;
        box-shadow: none;
        background: none;
        border: none;
      }

      .popup-body {
        font-family: var(--font-primary);
        color: var(--color-black);
        line-height: 1.4;
        font-size: 0.9rem;
      }

    }

  </style>

</head>

<body>

  <!-- Page congainer -->
  <div class="container">

    <!-- Header container, with title, subtitle, proCHW total, and accompanying text -->
    <div class="header">

      <!-- Left side of header -->
      <div class="header-section left">
        <div id="total-accredited-and-salaried"></div>
      </div>

      <!-- Middle of header -->
      <div id="totaltext" class="header-section middle">COUNTRIES CURRENTLY HAVE ONE OR MORE CHW GROUPS WHO ARE ACCREDITED AND SALARIED</div>

      <!-- Right side of header -->
      <div class="header-section right">
        <button type="button" id="how-to-use-button" class="how-to-use-button">
          <span class="play-icon"></span>
          HOW TO USE THE DASHBOARD
        </button>
      </div>

    </div>

    <!-- How to Use Dashboard Popup -->
    <div id="how-to-use-popup" class="popup-overlay">
      <div class="popup-content">
        <div class="popup-header">
          <h3>HOW TO USE THE DASHBOARD</h3>
          <button type="button" id="close-popup" class="close-button">&times;</button>
        </div>
        <div class="popup-body">
          <p>[INSTRUCTIONAL VIDEO GOES HERE]</p>
        </div>
      </div>
    </div>

    <!-- Download Data popup -->
    <div id="download-popup" class="popup-overlay">
      <div class="popup-content">
        <div class="popup-header">
          <h3>WHAT WOULD YOU LIKE TO DOWNLOAD?</h3>
          <button type="button" id="close-download-popup" class="close-button">&times;</button>
        </div>
        <div class="popup-body">
          <p style="margin-bottom: 1.5em;">Note the map image option downloads the current map view. If you wish to download a different view, please go back to the map, select your desired indicator, and zoom to your desired map area before coming back to download your image.</p>
          <div style="display: flex; flex-direction: column; gap: 1em;">
            <button type="button" id="download-map-button" class="buttonsidebar" style="width: 100%; padding: 1em; cursor: pointer; text-transform: uppercase;">
              HIGH-RESOLUTION MAP IMAGE
            </button>
            <button type="button" id="download-data-button" class="buttonsidebar" style="width: 100%; padding: 1em; cursor: pointer; text-transform: uppercase;">
              RAW DATA
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit for Review popup -->
    <div id="submit-review-popup" class="popup-overlay">
      <div class="popup-content">
        <div class="popup-header">
          <h3>SUBMIT FOR REVIEW</h3>
          <button type="button" id="close-submit-review-popup" class="close-button">&times;</button>
        </div>
        <div class="popup-body">
          <p style="margin-bottom: 1.5em;">What would you like to submit for review?</p>
          <div style="display: flex; flex-direction: column; gap: 1em;">
            <button type="button" id="submit-correction-button" class="buttonsidebar" style="width: 100%; padding: 1em; cursor: pointer; text-transform: uppercase;">
              correction to dashboard information
            </button>
            <button type="button" id="submit-policy-button" class="buttonsidebar" style="width: 100%; padding: 1em; cursor: pointer; text-transform: uppercase;">
              CHW policy document
            </button>
            <button type="button" id="submit-association-button" class="buttonsidebar" style="width: 100%; padding: 1em; cursor: pointer; text-transform: uppercase;">
              CHW association information
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Map container with map inside -->
    <div id="map" class="content-section map">
      <!-- Legend and Download Container -->
      <div class="legend-and-download-container">
        <div id="legend" class="legend">
          <h4 id="legend-title"></h4>
          <div id="legenditems"></div>
        </div>
        
        <button type="button" id="download-button" class="download-button">
          Download High-Res Image or Raw Data
        </button>
      </div>
    </div>

    <!-- Button container -->
    <div id="buttoncontainer" class="buttoncontainer">
      <div class="button-row">
        <div class="button-with-tooltip">
          <button type="button" id="accredited-chws-button" class="button">ACCREDITED CHWS</button>
          <div class="accredited-chws-button-def">Does the country policy document explicitly recognize
            roles, qualifications, and competencies for CHWs?
          </div>
        </div>
        <div class="button-with-tooltip">
          <button type="button" id="salaried-chws-button" class="button">SALARIED CHWS</button>
          <div class="salaried-chws-button-def">Does the policy document provide for CHWs to be compensated
            through government wage bills? (Policies that stipulate CHW remuneration via performance-based
            incentives, stipends, and/or non-financial incentives like gumboots, t-shirts, soap, and
            batteries were coded as "No".)
          </div>
        </div>
        <div class="button-with-tooltip">
          <button type="button" id="accredited-and-salaried-chws-button" class="button">ACCREDITED & SALARIED CHWS</button>
          <div class="accredited-and-salaried-chws-button-def">For purposes of
            this dashboard, we focus on two of the eight best practices that are indicative of formal,
            fulfilling, and dignified labor conditions and for which sufficient data exists in policy
            documents: accreditation and compensation.
          </div>
        </div>
        <div class="button-with-tooltip">
          <button type="button" id="policy-status-button" class="button">POLICY STATUS</button>
          <div class="policy-status-button-def">What is the status of the country's policy?
          </div>
        </div>
        <div class="button-with-tooltip">
          <button type="button" id="implementation-evidence-button" class="button">IMPLEMENTATION EVIDENCE</button>
          <div class="implementation-evidence-button-def">Is there any evidence of CHW policy implementation, as measured by the presence of any one of seven proxy indicators?
          </div>
        </div>
      </div>
      
      <!-- Search bar container -->
      <div id="searchcontainer" class="searchcontainer">
        <input type="text" id="country-search" placeholder="Search for a country..." class="search-input">
        <div id="search-results" class="search-results"></div>
      </div>

    </div>

    <!-- Sidebar -->
    <div class="content-section sidebar">

      <!-- Country details section within sidebar -->
      <div id='country-details' class='country-details'>

        <div id="country-name">Select a country to see details</div>
        <div id="out-of-scope-message" class="out-of-scope-text" style="display: none;">
          Out of Scope
        </div>
        
        <!-- CHW Cards Container -->
        <div id="chw-cards-container" class="chw-cards-container" style="display: none;">
          <!-- Total CHW Groups Card -->
          <div id="total-chw-groups-card" class="chw-card">
            <div id="total-chw-groups-number" class="chw-card-number"></div>
            <div class="chw-card-label">Total CHW Groups</div>
          </div>
          
          <!-- Salaried & Accredited Card -->
          <div id="salaried-accredited-card" class="chw-card">
            <div id="salaried-accredited-number" class="chw-card-number"></div>
            <div class="chw-card-label">Salaried & Accredited</div>
          </div>
          
          <!-- CHW Associations Card -->
          <div id="chw-associations-card" class="chw-card">
            <div id="chw-associations-number" class="chw-card-number"></div>
            <div class="chw-card-label">CHW Associations</div>
          </div>
        </div>
        
        <!-- CHW Popups Container -->
        <div id="chw-popups-container" class="chw-popups-container">
          <div id="total-chw-groups-popup" class="chw-popup">
            <div class="chw-popup-title">All CHW Group(s):</div>
            <ul id="total-chw-groups-list" class="chw-popup-list"></ul>
          </div>
          
          <div id="salaried-accredited-popup" class="chw-popup">
            <div class="chw-popup-title">Salaried & Accredited Group(s):</div>
            <ul id="salaried-accredited-list" class="chw-popup-list"></ul>
          </div>
          
          <div id="chw-associations-popup" class="chw-popup">
            <div class="chw-popup-title">CHW Association(s):</div>
            <ul id="chw-associations-list" class="chw-popup-list"></ul>
          </div>
        </div>
        
        <!-- Policy Status Card -->
        <div id="policy-status-card" class="policy-status-card" style="display: none;">
          <div class="policy-status-header">
            <div class="policy-status-title">Policy Status</div>
            <div id="policy-status-badge" class="policy-status-badge"></div>
          </div>
          <div class="policy-status-content">
            <div class="policy-status-line">
              <span class="policy-status-label">Implementation</span>
              <span id="policy-implementation-text" class="policy-status-value"></span>
            </div>
            <div class="policy-status-line">
              <span class="policy-status-label">Policy Years</span>
              <span id="policy-years-text" class="policy-status-value"></span>
            </div>
            <div class="policy-status-divider"></div>
            <div id="policy-link-container" class="policy-link-container">
              <a id="policy-link" href="#" target="_blank" class="policy-link">View policy document </a>
            </div>
          </div>
        </div>
        
        <!-- Accreditation, Salary, Supervision, Skills, & Supplies Section -->
        <div id="accreditation-section" class="accreditation-section" style="display: none;">
          <div class="accreditation-section-header">
            <div class="accreditation-section-title">ACCREDITATION, SALARY, SUPERVISION, SKILLS, & SUPPLIES</div>
            <div class="accreditation-section-arrow">></div>
          </div>
          <div class="accreditation-section-subtitle">Does the policy reflect formal commitments to professional CHWs?</div>
          <div class="accreditation-section-content" style="display: none;">
            <!-- Accreditation Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">ACCREDITATION</div>
                <div class="accreditation-subsection-description" id="accreditation-description"></div>
                <div class="accreditation-subsection-source" id="accreditation-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="accreditation-indicator"></div>
                <div class="indicator-text" id="accreditation-text"></div>
              </div>
            </div>
            
            <!-- Salary Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">SALARY</div>
                <div class="accreditation-subsection-description" id="salary-description"></div>
                <div class="accreditation-subsection-source" id="salary-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="salary-indicator"></div>
                <div class="indicator-text" id="salary-text"></div>
              </div>
            </div>
            
            <!-- Supervision Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">SUPERVISION</div>
                <div class="accreditation-subsection-description" id="supervision-description"></div>
                <div class="accreditation-subsection-source" id="supervision-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="supervision-indicator"></div>
                <div class="indicator-text" id="supervision-text"></div>
              </div>
            </div>
            
            <!-- Skills Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">SKILLS</div>
                <div class="accreditation-subsection-description" id="skills-description"></div>
                <div class="accreditation-subsection-source" id="skills-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="skills-indicator"></div>
                <div class="indicator-text" id="skills-text"></div>
              </div>
            </div>
            
            <!-- Supplies Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">SUPPLIES</div>
                <div class="accreditation-subsection-description" id="supplies-description"></div>
                <div class="accreditation-subsection-source" id="supplies-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="supplies-indicator"></div>
                <div class="indicator-text" id="supplies-text"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Policy Implementation Section -->
        <div id="policy-implementation-section" class="accreditation-section" style="display: none;">
          <div class="accreditation-section-header">
            <div class="accreditation-section-title">POLICY IMPLEMENTATION</div>
            <div class="accreditation-section-arrow">></div>
          </div>
          <div class="accreditation-section-subtitle">Is there any evidence of CHW policy implementation, as measured by the presence of any one of five proxy indicators?</div>
          <div class="accreditation-section-content" style="display: none;">
            <!-- Domestic Financing Commitment Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">DOMESTIC FINANCING COMMITMENT</div>
                <div class="accreditation-subsection-description" id="domestic-financing-commitment-description"></div>
                <div class="accreditation-subsection-source" id="domestic-financing-commitment-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="domestic-financing-commitment-indicator"></div>
                <div class="indicator-text" id="domestic-financing-commitment-text"></div>
              </div>
            </div>
            
            <!-- CHW Budget Line Item Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">CHW BUDGET LINE ITEM</div>
                <div class="accreditation-subsection-description" id="chw-budget-line-item-description"></div>
                <div class="accreditation-subsection-source" id="chw-budget-line-item-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="chw-budget-line-item-indicator"></div>
                <div class="indicator-text" id="chw-budget-line-item-text"></div>
              </div>
            </div>
            
            <!-- Data Systems / Feedback Loops Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">DATA SYSTEMS / FEEDBACK LOOPS</div>
                <div class="accreditation-subsection-description" id="data-systems-description"></div>
                <div class="accreditation-subsection-source" id="data-systems-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="data-systems-indicator"></div>
                <div class="indicator-text" id="data-systems-text"></div>
              </div>
            </div>
            
            <!-- MERL / M&E Framework Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">MERL / M&E FRAMEWORK</div>
                <div class="accreditation-subsection-description" id="merl-description"></div>
                <div class="accreditation-subsection-source" id="merl-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="merl-indicator"></div>
                <div class="indicator-text" id="merl-text"></div>
              </div>
            </div>
            
            <!-- CHW Registry Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">CHW REGISTRY</div>
                <div class="accreditation-subsection-description" id="chw-registry-description"></div>
                <div class="accreditation-subsection-source" id="chw-registry-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="chw-registry-indicator"></div>
                <div class="indicator-text" id="chw-registry-text"></div>
              </div>
            </div>
            
            <!-- Costed Documentation Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">COSTED DOCUMENTATION</div>
                <div class="accreditation-subsection-description" id="costed-documentation-description"></div>
                <div class="accreditation-subsection-source" id="costed-documentation-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="costed-documentation-indicator"></div>
                <div class="indicator-text" id="costed-documentation-text"></div>
              </div>
            </div>
            
            <!-- Operational Materials Subsection -->
            <div class="accreditation-subsection">
              <div class="accreditation-subsection-content">
                <div class="accreditation-subsection-title">OPERATIONAL MATERIALS</div>
                <div class="accreditation-subsection-description" id="operational-materials-description"></div>
                <div class="accreditation-subsection-source" id="operational-materials-source"></div>
              </div>
              <div class="accreditation-subsection-indicator">
                <div class="indicator-circle" id="operational-materials-indicator"></div>
                <div class="indicator-text" id="operational-materials-text"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Policy Timeline Section -->
        <div id="policy-timeline-section" class="accreditation-section" style="display: none;">
          <div class="accreditation-section-header">
            <div class="accreditation-section-title">POLICY TIMELINE</div>
            <div class="accreditation-section-arrow">></div>
          </div>
          <div class="accreditation-section-content" style="display: none;">
            <div class="policy-timeline">
              <!-- Timeline Point 1 -->
              <div class="timeline-item">
                <div class="timeline-year" id="timeline-year-1"></div>
                <div class="timeline-milestone" id="timeline-milestone-1"></div>
              </div>
              
              <!-- Timeline Point 2 -->
              <div class="timeline-item">
                <div class="timeline-year" id="timeline-year-2"></div>
                <div class="timeline-milestone" id="timeline-milestone-2"></div>
              </div>
              
              <!-- Timeline Point 3 -->
              <div class="timeline-item">
                <div class="timeline-year" id="timeline-year-3"></div>
                <div class="timeline-milestone" id="timeline-milestone-3"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- AI-Generated Summary Card -->
        <div id="ai-summary-section" class="accreditation-section" style="display: none;">
          <div class="ai-summary-card">
            <div class="ai-summary-title">AI-GENERATED SUMMARY</div>
            <div class="ai-summary-content" id="ai-summary-text"></div>
          </div>
        </div>
        
        <!-- Submit for Review Button -->
        <button type="button" id="submit-review-button" class="buttonsidebar" style="display: none; margin-top: 3em; width: 100%; cursor: pointer; text-transform: uppercase;">
          See something missing? Submit it for review by the CHIC team
        </button>
        
        <!-- Bottom part of the sidebar -->
      <div id="bottom" class="bottom">

        <!-- Date last updated -->
        <div id="date-last-updated"></div>

      </div>

    </div>

  </div>

</body>

<script>

  // Initialize data
  let csvData = false

  // Basemap info
  mapboxgl.accessToken = 'pk.eyJ1IjoiY2hpY3BvbGljeWRhc2hib2FyZCIsImEiOiJjbGV5M3ZncXIwam96M3FuMGU4b3puMDVlIn0.aIXbEvRX7bYtEjBE2mmLTg';
  const map = new mapboxgl.Map({
    container: 'map', // container ID
    style: 'mapbox://styles/chicpolicydashboard/clf8f14r6000801qfp24pfnf2', // style URL
    center: [-3.0, -5.0], // starting position [lng, lat]
    zoom: 2, // starting zoom
    preserveDrawingBuffer: true // Required for exporting map as image
  });

  // Create function to build a legend
  function buildLegend(legendColors, legendValues) {
    // First empty legend items
    const item = $('#legenditems')
    item.empty()
    legendValues.forEach((legendValue, i) => {
      const color = legendColors[i];
      const key = document.createElement('span')
      key.className = 'legend-key';
      key.style.backgroundColor = color

      const value = document.createElement('span');
      value.innerHTML = `${legendValue}`;
      item.append(key);
      item.append(value);
      item.append(document.createElement("br"));
    })
  }

  // Create function to define how colors are added to map and to build the legend
  function setColorsToMap(indicatorName) {

    // Initialize arrays for the map colors, the legend colors, and the legend values
    var caseExpression = []

    // If indicator is salaried_accredited_cat:
    if (indicatorName == "salaried_accredited_cat") {

      // Initialize arrays for all possible values of this indicator
      let bothArray = []
      let oneArray = []
      let neitherArray = []
      let naArray = []

      // Push ISO codes from csv data to arrays based on values
      csvData.forEach((row) => {
        if (row[indicatorName] == "Both") {
          bothArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "Only paid or only accredited") {
          oneArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "Neither") {
          neitherArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No document available" || row[indicatorName] == "Not specified in documents reviewed") {
          naArray.push(row.ISO_A3)
        }
      })

      // Set Mapbox colors based on arrays
      var caseExpression = [
        'case',
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", bothArray]], "#9272d9",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", oneArray]], "#20bdc5",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", neitherArray]], "#F36744",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", naArray]], "#999999",
        "#dbdbdb"
      ]

      // Set legend title, colors and values manually
      $('#legend-title').text("Is at least one CHW group salaried & accredited?")
      const legendColors = ["#9272d9", "#20bdc5", "#F36744", "#999999", "#dbdbdb"]
      const legendValues = ["Both", "Only salaried or only accredited", "Neither", "No document available or not specified in documents reviewed", "Out of scope"]

      // Now build legend
      buildLegend(legendColors, legendValues)

    }

    // Else if indicator is at_least_1_accredited:
    if (indicatorName == "at_least_1_accredited") {

      // Initialize arrays for all possible values of this indicator
      let yArray = []
      let nArray = []
      let naArray = []

      // Push ISO codes from csv data to arrays based on values
      csvData.forEach((row) => {
        if (row[indicatorName] == "Yes") {
          yArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No") {
          nArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No document available" || row[indicatorName] == "Not specified in documents reviewed") {
          naArray.push(row.ISO_A3)
        }
      })

      // Set Mapbox colors based on arrays
      var caseExpression = [
        'case',
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", yArray]], "#9272d9",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", nArray]], "#F36744",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", naArray]], "#999999",
        "#dbdbdb"
      ]

      // Set legend title, colors and values manually
      $('#legend-title').text("Is at least one CHW group accredited?")
      var legendColors = ["#9272d9", "#F36744", "#999999", "#dbdbdb"]
      var legendValues = ["Yes", "No", "No document available or not specified in documents reviewed", "Out of scope"]

      // Now build legend
      buildLegend(legendColors, legendValues)

    }

    // Else if indicator is at_least_1_salaried:
    if (indicatorName == "at_least_1_salaried") {

      // Initialize arrays for all possible values of this indicator
      let yArray = []
      let nArray = []
      let naArray = []

      // Push ISO codes from csv data to arrays based on values
      csvData.forEach((row) => {
        if (row[indicatorName] == "Yes") {
          yArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No") {
          nArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No document available" || row[indicatorName] == "Not specified in documents reviewed") {
          naArray.push(row.ISO_A3)
        }
      })

      // Set Mapbox colors based on arrays
      var caseExpression = [
        'case',
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", yArray]], "#9272d9",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", nArray]], "#F36744",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", naArray]], "#999999",
        "#dbdbdb"
      ]

      // Set legend title, colors and values manually
      $('#legend-title').text("Is at least one CHW group salaried?")
      var legendColors = ["#9272d9", "#F36744", "#999999", "#dbdbdb"]
      var legendValues = ["Yes", "No", "No document available or not specified in documents reviewed", "Out of scope"]

      // Now build legend
      buildLegend(legendColors, legendValues)

    }

    // Else if indicator is policy status:
    if (indicatorName == "doc_status") {

      // Initialize arrays for all possible values of this indicator
      let activeArray = []
      let expiringArray = []
      let expiredArray = []
      let naArray = []

      // Push ISO codes from csv data to arrays based on values
      csvData.forEach((row) => {
        if (row[indicatorName] == "Active") {
          activeArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "Expiring within 2 years") {
          expiringArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "Expired") {
          expiredArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No document available") {
          naArray.push(row.ISO_A3)
        }
      })

      // Set Mapbox colors based on arrays
      var caseExpression = [
        'case',
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", activeArray]], "#9272d9",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", expiringArray]], "#20bdc5",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", expiredArray]], "#F36744",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", naArray]], "#999999",
        "#dbdbdb"
      ]

      // Set legend title, colors and values manually
      $('#legend-title').text("What is the country policy's status?")
      const legendColors = ["#9272d9", "#20bdc5", "#F36744", "#999999", "#dbdbdb"]
      const legendValues = ["Active", "Expiring within 2 years", "Expired", "No document available", "Out of scope"]

      // Now build legend
      buildLegend(legendColors, legendValues)

      }

    // Else if indicator is any_implementation_evidence:
    if (indicatorName == "any_implementation_evidence") {

      // Initialize arrays for all possible values of this indicator
      let yArray = []
      let nArray = []
      let naArray = []

      // Push ISO codes from csv data to arrays based on values
      csvData.forEach((row) => {
        if (row[indicatorName] == "Yes") {
          yArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No") {
          nArray.push(row.ISO_A3)
        }
        if (row[indicatorName] == "No document available" || row[indicatorName] == "Not specified in documents reviewed") {
          naArray.push(row.ISO_A3)
        }
      })

      // Set Mapbox colors based on arrays
      var caseExpression = [
        'case',
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", yArray]], "#9272d9",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", nArray]], "#F36744",
        ["in", ["get", "iso_3166_1_alpha_3"], ["literal", naArray]], "#999999",
        "#dbdbdb"
      ]

      // Set legend title, colors and values manually
      $('#legend-title').text("Is there any evidence of CHW policy implementation, as measured by the presence of any one of seven proxy indicators?")
      const legendColors = ["#9272d9", "#F36744", "#999999", "#dbdbdb"]
      const legendValues = ["Yes", "No", "No document available or not specified in documents reviewed", "Out of scope"]

      // Now build legend
      buildLegend(legendColors, legendValues)

      }

    // Now, based on results of if statements and indicator selected, set map colors 
    map.setPaintProperty('country-boundaries', 'fill-color', caseExpression)

  };

  // Create function to sum countries with data available for denominator 
  function denominator(sumDenominator) {

    let denominatorArray = []

    csvData.forEach((row) => {
      if (row[sumDenominator] == "Yes" || row[sumDenominator] == "No") {
        denominatorArray.push(row.ISO_A3)
      } 
    })

    return denominatorSum = denominatorArray.length

  };

  // Create function to sum counts for tickers
  function sumIndicators(sumIndicatorName) {

    let indicatorArray = []

    csvData.forEach((row) => {
      if (row[sumIndicatorName] == "Yes") {
        indicatorArray.push(row.ISO_A3)
      }
    })

    return indicatorSum = indicatorArray.length

  };

  // Resize map to its container on map render
  map.on('render', function () {
    map.resize();
  });

  // On map load, load csv data, color the map, load top scorecards, and set up for populating sidebar and hovers
  map.on('load', () => {

    // Set zoom level based on device
    var laptop = window.matchMedia("(min-width: 768px)");

    if (laptop.matches) {
      map.setZoom(2.3);
    }
    else {
      map.setZoom(.5);
    };

    // Fetch CSV data - this is where CHIC team will update data quarterly
    // WORKING VERSION: const sheetId = '2PACX-1vRW71f12hsPrtlEglo73Xcit8TgFw1WeyU4HXWNV3M-IasQMjvzhS3zWjlFTgm4NHFs_1KJjHaSPLCZ'
    // NEW BQ VERSION: const sheetId = '2PACX-1vSKosFU0tUSzF1esBHsppzU9fcGVytdbUSsp9jE48i4PXZP6hrq-KPf3Bhom5rly2Kdseawyiwm3PQj'
    // NEW SNOWFLAKE VERSION:
    const sheetId = '2PACX-1vQywgpExVZxfgBYhfqWB6DdBJc2jfC-2bDQJ3g0N8M-YGP5Jn1rkAO2rp2tRZob2sTmObPucw0bIBlS'
    // REAL SPREADSHEET const sheetId = '2PACX-1vQan4RTDeRovJT7VqPhh15B6GLNhvxVGTILpyjOIfbfEEf2Sd0Ky5xpPsRlLS9_9GmHeWVIwNcIU5X8'
    fetch(`https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?output=csv`)
      .catch(err => {})
      .then(resp => resp.text())
      .then(response => {
        csv().fromString(response)
          .then(rows => {
            csvData = rows

            // Add scorecard at top based on csv data
            const totalAccreditedAndSalaried = sumIndicators("at_least_1_salaried_accredited")
            const totalDenominator = denominator("at_least_1_salaried_accredited")
            $('#total-accredited-and-salaried').text(totalAccreditedAndSalaried + "/" + totalDenominator)

            // Initialize map with data for proCHW indicator
            setColorsToMap("salaried_accredited_cat")

            // Add button active state
            $('#accredited-and-salaried-chws-button').addClass('active');

            setTimeout(() => {
              map.setPaintProperty('country-boundaries', 'fill-opacity', 1)
            }, 1000)

          })
      })

    // Add event listeners for button clicks to change the map based on the indicator selected and toggle button to active state
    $("#accredited-chws-button").click(function () {
      setColorsToMap("at_least_1_accredited")
      $('.button').removeClass('active')
      $(this).addClass('active')
    })

    $("#salaried-chws-button").click(function () {
      setColorsToMap("at_least_1_salaried")
      $('.button').removeClass('active')
      $(this).addClass('active')
    })

    $("#accredited-and-salaried-chws-button").click(function () {
      setColorsToMap("salaried_accredited_cat")
      $('.button').removeClass('active')
      $(this).addClass('active')
    })

    $("#policy-status-button").click(function () {
      setColorsToMap("doc_status")
      $('.button').removeClass('active')
      $(this).addClass('active')
    })

    $("#implementation-evidence-button").click(function () {
      setColorsToMap("any_implementation_evidence")
      $('.button').removeClass('active')
      $(this).addClass('active')
    })


    // Search functionality
    const searchInput = document.getElementById('country-search');
    const searchResults = document.getElementById('search-results');

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      if (searchTerm.length === 0) {
        searchResults.style.display = 'none';
        return;
      }

      // Filter countries based on search term
      const filteredCountries = csvData.filter(country => 
        country.country.toLowerCase().includes(searchTerm)
      ).slice(0, 10); // Limit to 10 results

      if (filteredCountries.length > 0) {
        searchResults.innerHTML = '';
        filteredCountries.forEach(country => {
          const resultItem = document.createElement('div');
          resultItem.className = 'search-result-item';
          resultItem.textContent = country.country;
          resultItem.addEventListener('click', function() {
            // Clear previous country's data first
            clearPersistentData();
            
            // Find the country data and populate the sidebar
            const thisCountry = csvData.find(row => row.ISO_A3 === country.ISO_A3);
            
            if (thisCountry) {
              // Populate the sidebar with country information
              $("#country-name").text(thisCountry.country);
              $("#date-last-updated").text("Date last updated: " + thisCountry.date_last_updated);
              
              // Populate the entire sidebar
              populateSidebar(thisCountry);
              
              // Fly to the country using coordinates from CSV data
              if (thisCountry.longitude && thisCountry.latitude) {
                const lng = parseFloat(thisCountry.longitude);
                const lat = parseFloat(thisCountry.latitude);
                
                if (!isNaN(lng) && !isNaN(lat)) {
                  map.flyTo({
                    center: [lng, lat],
                    zoom: 3.5,
                    duration: 500,
                    essential: true
                  });
                }
              }
            }
            
            // Clear search
            searchInput.value = '';
            searchResults.style.display = 'none';
          });
          searchResults.appendChild(resultItem);
        });
        searchResults.style.display = 'block';
      } else {
        searchResults.innerHTML = '<div class="search-result-item">No countries found</div>';
        searchResults.style.display = 'block';
      }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    // Hide search results when pressing Escape
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        searchResults.style.display = 'none';
        this.blur();
      }
    });

    // CHW Cards functionality
    function populateCHWCards(countryData) {
      // Hide all popups when switching countries
      document.getElementById('total-chw-groups-popup').style.display = 'none';
      document.getElementById('salaried-accredited-popup').style.display = 'none';
      document.getElementById('chw-associations-popup').style.display = 'none';
      
      // Clear any existing "Data not available" text from popup titles
      const popupTitles = document.querySelectorAll('.chw-popup-title');
      popupTitles.forEach(title => {
        const dataNotAvailableText = title.querySelector('.data-not-available-text');
        if (dataNotAvailableText) {
          dataNotAvailableText.remove();
        }
      });
      
      // Check if country is out of scope
      if (countryData.countdown_country === "FALSE") {
        document.getElementById('chw-cards-container').style.display = 'none';
        document.getElementById('out-of-scope-message').style.display = 'block';
        return;
      }

      // Show cards and hide out of scope message
      document.getElementById('chw-cards-container').style.display = 'flex';
      document.getElementById('out-of-scope-message').style.display = 'none';

      // Helper function to check if data is available
      function isDataAvailable(value) {
        return value && value !== "Not specified in documents reviewed" && value !== "No document available" && value !== "";
      }

      // Helper function to create list items from semicolon-separated string
      function createListItems(dataString, listElement) {
        listElement.innerHTML = '';
        if (isDataAvailable(dataString)) {
          const items = dataString.split(';').map(item => item.trim()).filter(item => item);
          items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            listElement.appendChild(li);
          });
        } else {
          // For "Data not available", add italicized text after the title instead of bullets
          const popup = listElement.closest('.chw-popup');
          const title = popup.querySelector('.chw-popup-title');
          if (title && !title.querySelector('.data-not-available-text')) {
            const dataNotAvailableSpan = document.createElement('span');
            dataNotAvailableSpan.className = 'data-not-available-text';
            dataNotAvailableSpan.style.fontWeight = 'normal';
            dataNotAvailableSpan.style.fontStyle = 'italic';
            dataNotAvailableSpan.textContent = ' No document available or not specified in documents reviewed';
            title.appendChild(dataNotAvailableSpan);
          }
        }
      }

      // Populate Total CHW Groups Card
      const totalGroupsNumber = document.getElementById('total-chw-groups-number');
      const totalGroupsList = document.getElementById('total-chw-groups-list');
      
      if (isDataAvailable(countryData.group_count)) {
        totalGroupsNumber.textContent = countryData.group_count;
        totalGroupsNumber.className = 'chw-card-number';
      } else {
        totalGroupsNumber.textContent = 'No document available or not specified in documents reviewed';
        totalGroupsNumber.className = 'chw-card-number chw-card-number-not-available';
      }
      createListItems(countryData.group_names, totalGroupsList);

      // Populate Salaried & Accredited Card
      const salariedAccreditedNumber = document.getElementById('salaried-accredited-number');
      const salariedAccreditedList = document.getElementById('salaried-accredited-list');
      
      if (isDataAvailable(countryData.num_groups_salaried_accredited)) {
        salariedAccreditedNumber.textContent = countryData.num_groups_salaried_accredited;
        salariedAccreditedNumber.className = 'chw-card-number';
      } else {
        salariedAccreditedNumber.textContent = 'No document available or not specified in documents reviewed';
        salariedAccreditedNumber.className = 'chw-card-number chw-card-number-not-available';
      }
      createListItems(countryData.group_names_salaried_accredited, salariedAccreditedList);

      // Populate CHW Associations Card
      const associationsNumber = document.getElementById('chw-associations-number');
      const associationsList = document.getElementById('chw-associations-list');
      
      if (isDataAvailable(countryData.count_chw_associations) && parseInt(countryData.count_chw_associations) > 0) {
        associationsNumber.textContent = countryData.count_chw_associations;
        associationsNumber.className = 'chw-card-number';
        createListItems(countryData.chw_association_names, associationsList);
      } else if (countryData.count_chw_associations === "0" || !isDataAvailable(countryData.count_chw_associations)) {
        // Show count as 0 or "No document available"
        if (countryData.count_chw_associations === "0") {
          associationsNumber.textContent = countryData.count_chw_associations;
          associationsNumber.className = 'chw-card-number';
        } else {
          associationsNumber.textContent = 'No document available or not specified in documents reviewed';
          associationsNumber.className = 'chw-card-number chw-card-number-not-available';
        }
        
        // Clear the list and add custom message with link
        associationsList.innerHTML = '';
        const messageP = document.createElement('p');
        messageP.style.fontStyle = 'italic';
        messageP.style.padding = '0.5em 0';
        messageP.style.color = '#000000';
        messageP.innerHTML = 'CHIC is not aware of any CHW associations in this country. If you know of one, please <a href="#" id="submit-association-link" style="color: #4F2049; text-decoration: underline;">submit information here</a>.';
        associationsList.appendChild(messageP);
        
        // Add click event to the link
        setTimeout(() => {
          const link = document.getElementById('submit-association-link');
          if (link) {
            link.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              window.open('https://forms.gle/your-association-form-link', '_blank');
            });
          }
        }, 0);
      }

      // Populate Policy Status Card
      const policyStatusBadge = document.getElementById('policy-status-badge');
      const policyStatus = countryData.doc_status || 'No document available';
      
      // Remove existing status classes
      policyStatusBadge.classList.remove('out-of-scope', 'data-not-available', 'expired', 'active');
      
      // Add appropriate class and text based on policy status
      if (policyStatus === 'Out of Scope') {
        policyStatusBadge.classList.add('out-of-scope');
        policyStatusBadge.textContent = 'OUT OF SCOPE';
      } else if (policyStatus === 'No document available') {
        policyStatusBadge.classList.add('data-not-available');
        policyStatusBadge.textContent = 'NO DOCUMENT AVAILABLE';
      } else if (policyStatus === 'Expired' || policyStatus === 'Expiring within 2 years') {
        policyStatusBadge.classList.add('expired');
        policyStatusBadge.textContent = policyStatus.toUpperCase();
      } else if (policyStatus === 'Active') {
        policyStatusBadge.classList.add('active');
        policyStatusBadge.textContent = 'ACTIVE';
      } else {
        policyStatusBadge.classList.add('data-not-available');
        policyStatusBadge.textContent = policyStatus.toUpperCase();
      }
      
      // Populate implementation text
      const implementationText = document.getElementById('policy-implementation-text');
      implementationText.textContent = countryData.implementation_combined || 'Unknown';
      
      // Populate policy years text
      const policyYearsText = document.getElementById('policy-years-text');
      policyYearsText.textContent = countryData.doc_years_covered || 'No document available';
      
      // Handle policy link
      const policyLink = document.getElementById('policy-link');
      const policyLinkContainer = document.getElementById('policy-link-container');
      
      if (countryData.document_link && countryData.document_link !== 'No document available') {
        policyLink.href = countryData.document_link;
        policyLink.textContent = 'View policy document ';
        policyLink.style.display = 'inline';
        policyLink.style.color = '';
        // Remove any "Policy not available" span if it exists
        const notAvailableSpan = policyLinkContainer.querySelector('span');
        if (notAvailableSpan) {
          notAvailableSpan.remove();
        }
      } else {
        policyLink.style.display = 'none';
        // Only add the "Policy not available" span if it doesn't already exist
        if (!policyLinkContainer.querySelector('span')) {
          const notAvailableSpan = document.createElement('span');
          notAvailableSpan.className = 'policy-link';
          notAvailableSpan.style.color = '#999999';
          notAvailableSpan.textContent = 'Policy not available';
          policyLinkContainer.appendChild(notAvailableSpan);
        }
      }

      // Populate Accreditation Subsections
      populateAccreditationSubsections(countryData);
      
      // Populate Policy Implementation Subsections
      populatePolicyImplementationSubsections(countryData);
      
      // Populate Policy Timeline
      populatePolicyTimeline(countryData);
      
      // Populate AI Summary
      populateAISummary(countryData);
    }

    // Helper function to format quote text with line breaks and bullets
    function formatQuoteText(text) {
      if (!text) return text;
      
      // Replace line breaks (from Cmd+Enter in Google Sheets) with <br> tags
      let formatted = text.replace(/\n/g, '<br>');
      
      // Handle bullet points (lines starting with hyphen)
      // Split by <br>, check each line, and rebuild
      let lines = formatted.split('<br>');
      lines = lines.map(line => {
        let trimmedLine = line.trim();
        // If line starts with hyphen, replace with bullet and add spacing
        if (trimmedLine.startsWith('- ')) {
          // Replace the leading "- " with bullet character
          let bulletLine = trimmedLine.replace(/^-\s*/, ' ');
          return '<span style="display: block; margin-left: 1em;">' + bulletLine + '</span>';
        } else if (trimmedLine.startsWith('-')) {
          // Handle case where there's no space after hyphen
          let bulletLine = trimmedLine.replace(/^-/, ' ');
          return '<span style="display: block; margin-left: 1em;">' + bulletLine + '</span>';
        }
        return line;
      });
      
      return lines.join('<br>');
    }

    // Function to populate accreditation subsections
    function populateAccreditationSubsections(countryData) {
      // Helper function to create indicator
      function createIndicator(value, indicatorElement, textElement) {
        if (value === "Yes" || value === "yes") {
          indicatorElement.className = 'indicator-circle yes';
          indicatorElement.innerHTML = '';
          textElement.textContent = 'YES';
        } else if (value === "No" || value === "no") {
          indicatorElement.className = 'indicator-circle no';
          indicatorElement.innerHTML = '';
          textElement.textContent = 'NO';
        } else {
          indicatorElement.className = 'indicator-circle na';
          indicatorElement.innerHTML = '?';
          textElement.textContent = 'N/A';
        }
      }

      // Helper function to set description with quotes
      function setDescription(descriptionElement, indicatorValue, quoteValue, sourceText) {
        // Check if indicator is "No" and quote/source are blank
        if ((indicatorValue === "No" || indicatorValue === "no") && 
            (!quoteValue || quoteValue === "" || quoteValue === "No document available" || quoteValue === "Not specified in documents reviewed") &&
            (!sourceText || sourceText === "" || sourceText === "No document available" || sourceText === "Not specified in documents reviewed")) {
          descriptionElement.textContent = 'No evidence of this indicator was found in the documents reviewed';
        } 
        // Check if indicator is N/A (not specified or no document available)
        else if (indicatorValue !== "Yes" && indicatorValue !== "yes" && indicatorValue !== "No" && indicatorValue !== "no") {
          descriptionElement.textContent = 'No document available or not specified in documents reviewed';
        }
        // Otherwise show the quote with formatting
        else if (quoteValue && quoteValue !== "No document available" && quoteValue !== "Not specified in documents reviewed" && quoteValue !== "") {
          descriptionElement.innerHTML = formatQuoteText(quoteValue);
        } else {
          descriptionElement.textContent = 'No document available or not specified in documents reviewed';
        }
      }

      // Helper function to set source link
      function setSource(sourceElement, sourceText, sourceLink, pageNumber) {
        if (sourceText && sourceText !== "No document available" && sourceText !== "Not specified in documents reviewed" && sourceText !== "" && 
            sourceLink && sourceLink !== "No document available" && sourceLink !== "Not specified in documents reviewed" && sourceLink !== "") {
          // Format source text with page number if available
          let displayText = sourceText;
          if (pageNumber && pageNumber !== "" && pageNumber !== "No document available" && pageNumber !== "Not specified in documents reviewed") {
            displayText = `${sourceText} (${pageNumber})`;
          }
          sourceElement.innerHTML = `<a href="${sourceLink}" target="_blank">${displayText}</a>`;
          // Add click event listener to prevent event bubbling
          const link = sourceElement.querySelector('a');
          if (link) {
            link.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          }
        } else {
          sourceElement.textContent = '';
        }
      }

      // Accreditation (Column Z for yes/no, Column AA for description)
      createIndicator(
        countryData.accreditation_policy || 'No document available or not specified in documents reviewed',
        document.getElementById('accreditation-indicator'),
        document.getElementById('accreditation-text')
      );
      setDescription(
        document.getElementById('accreditation-description'),
        countryData.accreditation_policy,
        countryData.accreditation_quote,
        countryData.accreditation_quote_source
      );
      setSource(
        document.getElementById('accreditation-source'),
        countryData.accreditation_quote_source,
        countryData.accreditation_quote_source_link,
        countryData.accreditation_quote_page
      );

      // Salary (Column AD for yes/no, Column AE for description)
      createIndicator(
        countryData.salary_policy || 'No document available or not specified in documents reviewed',
        document.getElementById('salary-indicator'),
        document.getElementById('salary-text')
      );
      setDescription(
        document.getElementById('salary-description'),
        countryData.salary_policy,
        countryData.salary_quote,
        countryData.salary_quote_source
      );
      setSource(
        document.getElementById('salary-source'),
        countryData.salary_quote_source,
        countryData.salary_quote_source_link,
        countryData.salaried_quote_page
      );

      // Supervision (Column AH for yes/no, Column AI for description)
      createIndicator(
        countryData.supervision_policy || 'No document available or not specified in documents reviewed',
        document.getElementById('supervision-indicator'),
        document.getElementById('supervision-text')
      );
      setDescription(
        document.getElementById('supervision-description'),
        countryData.supervision_policy,
        countryData.supervision_quote,
        countryData.supervision_quote_source
      );
      setSource(
        document.getElementById('supervision-source'),
        countryData.supervision_quote_source,
        countryData.supervision_quote_source_link,
        countryData.supervision_quote_page
      );

      // Skills (Column AL for yes/no, Column AM for description)
      createIndicator(
        countryData.skills_policy || 'No document available or not specified in documents reviewed',
        document.getElementById('skills-indicator'),
        document.getElementById('skills-text')
      );
      setDescription(
        document.getElementById('skills-description'),
        countryData.skills_policy,
        countryData.skills_quote,
        countryData.skills_quote_source
      );
      setSource(
        document.getElementById('skills-source'),
        countryData.skills_quote_source,
        countryData.skills_quote_source_link,
        countryData.skills_quote_page
      );

      // Supplies (Column AP for yes/no, Column AQ for description)
      createIndicator(
        countryData.supplies_policy || 'No document available or not specified in documents reviewed',
        document.getElementById('supplies-indicator'),
        document.getElementById('supplies-text')
      );
      setDescription(
        document.getElementById('supplies-description'),
        countryData.supplies_policy,
        countryData.supplies_quote,
        countryData.supplies_quote_source
      );
      setSource(
        document.getElementById('supplies-source'),
        countryData.supplies_quote_source,
        countryData.supplies_quote_source_link,
        countryData.supplies_quote_page
      );
    }

    // Function to populate policy implementation subsections
    function populatePolicyImplementationSubsections(countryData) {
      // Helper function to create indicator
      function createIndicator(value, indicatorElement, textElement) {
        if (value === "Yes" || value === "yes") {
          indicatorElement.className = 'indicator-circle yes';
          indicatorElement.innerHTML = '';
          textElement.textContent = 'YES';
        } else if (value === "No" || value === "no") {
          indicatorElement.className = 'indicator-circle no';
          indicatorElement.innerHTML = '';
          textElement.textContent = 'NO';
        } else {
          indicatorElement.className = 'indicator-circle na';
          indicatorElement.innerHTML = '?';
          textElement.textContent = 'N/A';
        }
      }

      // Helper function to set description with quotes
      function setDescription(descriptionElement, indicatorValue, quoteValue, sourceText) {
        // Check if indicator is "No" and quote/source are blank
        if ((indicatorValue === "No" || indicatorValue === "no") && 
            (!quoteValue || quoteValue === "" || quoteValue === "No document available" || quoteValue === "Not specified in documents reviewed") &&
            (!sourceText || sourceText === "" || sourceText === "No document available" || sourceText === "Not specified in documents reviewed")) {
          descriptionElement.textContent = 'No evidence of this indicator was found in the documents reviewed';
        } 
        // Check if indicator is N/A (not specified or no document available)
        else if (indicatorValue !== "Yes" && indicatorValue !== "yes" && indicatorValue !== "No" && indicatorValue !== "no") {
          descriptionElement.textContent = 'No document available or not specified in documents reviewed';
        }
        // Otherwise show the quote with formatting
        else if (quoteValue && quoteValue !== "No document available" && quoteValue !== "Not specified in documents reviewed" && quoteValue !== "") {
          descriptionElement.innerHTML = formatQuoteText(quoteValue);
        } else {
          descriptionElement.textContent = 'No document available or not specified in documents reviewed';
        }
      }

      // Helper function to set source link
      function setSource(sourceElement, sourceText, sourceLink, pageNumber) {
        if (sourceText && sourceText !== "No document available" && sourceText !== "Not specified in documents reviewed" && sourceText !== "" && 
            sourceLink && sourceLink !== "No document available" && sourceLink !== "Not specified in documents reviewed" && sourceLink !== "") {
          // Format source text with page number if available
          let displayText = sourceText;
          if (pageNumber && pageNumber !== "" && pageNumber !== "No document available" && pageNumber !== "Not specified in documents reviewed") {
            displayText = `${sourceText} (${pageNumber})`;
          }
          sourceElement.innerHTML = `<a href="${sourceLink}" target="_blank">${displayText}</a>`;
          // Add click event listener to prevent event bubbling
          const link = sourceElement.querySelector('a');
          if (link) {
            link.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          }
        } else {
          sourceElement.textContent = '';
        }
      }

      // Domestic Financing Commitment
      createIndicator(
        countryData.domestic_financing_commitment || 'No document available or not specified in documents reviewed',
        document.getElementById('domestic-financing-commitment-indicator'),
        document.getElementById('domestic-financing-commitment-text')
      );
      setDescription(
        document.getElementById('domestic-financing-commitment-description'),
        countryData.domestic_financing_commitment,
        countryData.domestic_financing_commitment_quote,
        countryData.domestic_financing_commitment_quote_source
      );
      setSource(
        document.getElementById('domestic-financing-commitment-source'),
        countryData.domestic_financing_commitment_quote_source,
        countryData.domestic_financing_commitment_quote_source_link,
        countryData.domestic_financing_commitment_quote_page
      );

      // CHW Budget Line Item
      createIndicator(
        countryData.chw_budget_line_item || 'No document available or not specified in documents reviewed',
        document.getElementById('chw-budget-line-item-indicator'),
        document.getElementById('chw-budget-line-item-text')
      );
      setDescription(
        document.getElementById('chw-budget-line-item-description'),
        countryData.chw_budget_line_item,
        countryData.chw_budget_line_item_quote,
        countryData.chw_budget_line_item_quote_source
      );
      setSource(
        document.getElementById('chw-budget-line-item-source'),
        countryData.chw_budget_line_item_quote_source,
        countryData.chw_budget_line_item_quote_source_link,
        countryData.chw_budget_line_item_quote_page
      );

      // Data Systems / Feedback Loops
      createIndicator(
        countryData.data_systems || 'No document available or not specified in documents reviewed',
        document.getElementById('data-systems-indicator'),
        document.getElementById('data-systems-text')
      );
      setDescription(
        document.getElementById('data-systems-description'),
        countryData.data_systems,
        countryData.data_systems_quote,
        countryData.data_systems_quote_source
      );
      setSource(
        document.getElementById('data-systems-source'),
        countryData.data_systems_quote_source,
        countryData.data_systems_quote_source_link,
        countryData.data_systems_quote_page
      );

      // MERL / M&E Framework
      createIndicator(
        countryData.merl || 'No document available or not specified in documents reviewed',
        document.getElementById('merl-indicator'),
        document.getElementById('merl-text')
      );
      setDescription(
        document.getElementById('merl-description'),
        countryData.merl,
        countryData.merl_quote,
        countryData.merl_quote_source
      );
      setSource(
        document.getElementById('merl-source'),
        countryData.merl_quote_source,
        countryData.merl_quote_source_link,
        countryData.merl_quote_page
      );

      // CHW Registry
      createIndicator(
        countryData.chw_registry || 'No document available or not specified in documents reviewed',
        document.getElementById('chw-registry-indicator'),
        document.getElementById('chw-registry-text')
      );
      setDescription(
        document.getElementById('chw-registry-description'),
        countryData.chw_registry,
        countryData.chw_registry_quote,
        countryData.chw_registry_quote_source
      );
      setSource(
        document.getElementById('chw-registry-source'),
        countryData.chw_registry_quote_source,
        countryData.chw_registry_quote_source_link,
        countryData.chw_registry_quote_page
      );

      // Costed Documentation
      createIndicator(
        countryData.costed || 'No document available or not specified in documents reviewed',
        document.getElementById('costed-documentation-indicator'),
        document.getElementById('costed-documentation-text')
      );
      setDescription(
        document.getElementById('costed-documentation-description'),
        countryData.costed,
        countryData.costed_quote,
        countryData.costed_quote_source
      );
      setSource(
        document.getElementById('costed-documentation-source'),
        countryData.costed_quote_source,
        countryData.costed_quote_source_link,
        countryData.costed_quote_page
      );

      // Operational Materials
      createIndicator(
        countryData.operational || 'No document available or not specified in documents reviewed',
        document.getElementById('operational-materials-indicator'),
        document.getElementById('operational-materials-text')
      );
      setDescription(
        document.getElementById('operational-materials-description'),
        countryData.operational,
        countryData.operational_quote,
        countryData.operational_quote_source
      );
      setSource(
        document.getElementById('operational-materials-source'),
        countryData.operational_quote_source,
        countryData.operational_quote_source_link,
        countryData.operational_quote_page
      );
    }

    // Function to populate policy timeline
    function populatePolicyTimeline(countryData) {
      // Helper function to check if data is available
      function hasData(value) {
        return value && value !== "No document available" && value !== "Not specified in documents reviewed" && value !== "";
      }
      
      // Helper function to set timeline milestone
      function setTimelineMilestone(yearElement, milestoneElement, year, milestoneText, milestoneLink) {
        // Set year
        if (hasData(year)) {
          yearElement.textContent = year;
        } else {
          yearElement.textContent = '';
        }

        // Set milestone text and link
        if (hasData(milestoneText)) {
          if (hasData(milestoneLink)) {
            milestoneElement.innerHTML = `<a href="${milestoneLink}" target="_blank">${milestoneText}</a>`;
            // Add click event listener to prevent event bubbling
            const link = milestoneElement.querySelector('a');
            if (link) {
              link.addEventListener('click', function(e) {
                e.stopPropagation();
              });
            }
          } else {
            milestoneElement.textContent = milestoneText;
          }
        } else {
          milestoneElement.textContent = '';
        }
      }

      // Check if any milestone data exists
      const hasMilestone1 = hasData(countryData.policy_timeline_milestone_1);
      const hasMilestone2 = hasData(countryData.policy_timeline_milestone_2);
      const hasMilestone3 = hasData(countryData.policy_timeline_milestone_3);
      const hasAnyMilestones = hasMilestone1 || hasMilestone2 || hasMilestone3;
      
      const timelineSection = document.getElementById('policy-timeline-section');
      
      if (hasAnyMilestones) {
        // Timeline Point 1
        setTimelineMilestone(
          document.getElementById('timeline-year-1'),
          document.getElementById('timeline-milestone-1'),
          countryData.policy_timeline_year_1,
          countryData.policy_timeline_milestone_1,
          countryData.policy_timeline_milestone_1_link
        );

        // Timeline Point 2
        setTimelineMilestone(
          document.getElementById('timeline-year-2'),
          document.getElementById('timeline-milestone-2'),
          countryData.policy_timeline_year_2,
          countryData.policy_timeline_milestone_2,
          countryData.policy_timeline_milestone_2_link
        );

        // Timeline Point 3
        setTimelineMilestone(
          document.getElementById('timeline-year-3'),
          document.getElementById('timeline-milestone-3'),
          countryData.policy_timeline_year_3,
          countryData.policy_timeline_milestone_3,
          countryData.policy_timeline_milestone_3_link
        );
        
        if (timelineSection) {
          timelineSection.style.display = 'block';
        }
      } else {
        // Hide the timeline section if no milestone data exists
        if (timelineSection) {
          timelineSection.style.display = 'none';
        }
      }
    }

    // Function to populate AI summary
    function populateAISummary(countryData) {
      const summaryElement = document.getElementById('ai-summary-text');
      const summarySection = document.getElementById('ai-summary-section');
      
      if (summaryElement && summarySection) {
        // Check if document is available and summary data exists
        if (countryData.doc_status !== "No document available" && 
            countryData.ai_summary_sentences && 
            countryData.ai_summary_sentences !== "No document available" && 
            countryData.ai_summary_sentences !== "Not specified in documents reviewed" && 
            countryData.ai_summary_sentences !== "") {
          summaryElement.innerHTML = formatQuoteText(countryData.ai_summary_sentences);
          summarySection.style.display = 'block';
        } else {
          summarySection.style.display = 'none';
        }
      }
    }

    // Add click event listeners for CHW cards
    document.getElementById('total-chw-groups-card').addEventListener('click', function() {
      // Hide all other popups first
      document.getElementById('salaried-accredited-popup').style.display = 'none';
      document.getElementById('chw-associations-popup').style.display = 'none';
      
      // Toggle the clicked popup
      const popup = document.getElementById('total-chw-groups-popup');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('salaried-accredited-card').addEventListener('click', function() {
      // Hide all other popups first
      document.getElementById('total-chw-groups-popup').style.display = 'none';
      document.getElementById('chw-associations-popup').style.display = 'none';
      
      // Toggle the clicked popup
      const popup = document.getElementById('salaried-accredited-popup');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('chw-associations-card').addEventListener('click', function() {
      // Hide all other popups first
      document.getElementById('total-chw-groups-popup').style.display = 'none';
      document.getElementById('salaried-accredited-popup').style.display = 'none';
      
      // Toggle the clicked popup
      const popup = document.getElementById('chw-associations-popup');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
    });

    // Add click event listener for accreditation section
    const accreditationSection = document.getElementById('accreditation-section');
    if (accreditationSection) {
      accreditationSection.addEventListener('click', function() {
        const content = this.querySelector('.accreditation-section-content');
        const isExpanded = this.classList.contains('expanded');
        
        if (isExpanded) {
          content.style.display = 'none';
          this.classList.remove('expanded');
        } else {
          content.style.display = 'block';
          this.classList.add('expanded');
        }
      });
    }

    // Add click event listener for policy implementation section
    const policyImplementationSection = document.getElementById('policy-implementation-section');
    if (policyImplementationSection) {
      policyImplementationSection.addEventListener('click', function() {
        const content = this.querySelector('.accreditation-section-content');
        const isExpanded = this.classList.contains('expanded');
        
        if (isExpanded) {
          content.style.display = 'none';
          this.classList.remove('expanded');
        } else {
          content.style.display = 'block';
          this.classList.add('expanded');
        }
      });
    }

    // Add click event listener for policy timeline section
    const policyTimelineSection = document.getElementById('policy-timeline-section');
    if (policyTimelineSection) {
      policyTimelineSection.addEventListener('click', function() {
        const content = this.querySelector('.accreditation-section-content');
        const isExpanded = this.classList.contains('expanded');
        
        if (isExpanded) {
          content.style.display = 'none';
          this.classList.remove('expanded');
        } else {
          content.style.display = 'block';
          this.classList.add('expanded');
        }
      });
    }

    // Function to clear persistent data that might carry over between countries
    function clearPersistentData() {
      // Clear all subsections (these were persisting)
      clearAllSubsections();
      
      // Collapse all expandable sections
      document.getElementById('accreditation-section').classList.remove('expanded');
      document.getElementById('accreditation-section').querySelector('.accreditation-section-content').style.display = 'none';
      document.getElementById('policy-implementation-section').classList.remove('expanded');
      document.getElementById('policy-implementation-section').querySelector('.accreditation-section-content').style.display = 'none';
      document.getElementById('policy-timeline-section').classList.remove('expanded');
      document.getElementById('policy-timeline-section').querySelector('.accreditation-section-content').style.display = 'none';
      
      // Hide AI summary section
      document.getElementById('ai-summary-section').style.display = 'none';
      
      // Hide submit button (will be shown again when new country is selected)
      document.getElementById('submit-review-button').style.display = 'none';
    }

    // Function to clear all subsections (accreditation and policy implementation)
    function clearAllSubsections() {
      // Clear accreditation subsections
      const accreditationSubsections = ['accreditation', 'salary', 'supervision', 'skills', 'supplies'];
      
      accreditationSubsections.forEach(subsection => {
        const indicator = document.getElementById(`${subsection}-indicator`);
        const text = document.getElementById(`${subsection}-text`);
        const description = document.getElementById(`${subsection}-description`);
        const source = document.getElementById(`${subsection}-source`);
        
        if (indicator) {
          indicator.className = 'indicator-circle';
          indicator.innerHTML = '';
        }
        if (text) {
          text.textContent = '';
        }
        if (description) {
          description.textContent = '';
        }
        if (source) {
          source.textContent = '';
        }
      });

      // Clear policy implementation subsections
      const policyImplementationSubsections = [
        'domestic-financing-commitment', 
        'chw-budget-line-item', 
        'data-systems', 
        'merl', 
        'chw-registry',
        'costed-documentation',
        'operational-materials'
      ];
      
      policyImplementationSubsections.forEach(subsection => {
        const indicator = document.getElementById(`${subsection}-indicator`);
        const text = document.getElementById(`${subsection}-text`);
        const description = document.getElementById(`${subsection}-description`);
        const source = document.getElementById(`${subsection}-source`);
        
        if (indicator) {
          indicator.className = 'indicator-circle';
          indicator.innerHTML = '';
        }
        if (text) {
          text.textContent = '';
        }
        if (description) {
          description.textContent = '';
        }
        if (source) {
          source.textContent = '';
        }
      });

      // Clear policy timeline
      const timelineElements = [
        'timeline-year-1', 'timeline-milestone-1',
        'timeline-year-2', 'timeline-milestone-2', 
        'timeline-year-3', 'timeline-milestone-3'
      ];
      
      timelineElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = '';
        }
      });
    }

    // Function to populate the entire sidebar
    function populateSidebar(countryData) {
      if (countryData.countdown_country === "FALSE") {
        // Country is out of scope - show only out of scope message
        document.getElementById('out-of-scope-message').style.display = 'block';
        document.getElementById('out-of-scope-message').textContent = "This country is not a Countdown to 2030 country, so it is out of scope for this dashboard.";
        
        // Hide all other elements
        document.getElementById('chw-cards-container').style.display = 'none';
        document.getElementById('chw-popups-container').style.display = 'none';
        document.getElementById('policy-status-card').style.display = 'none';
        document.getElementById('accreditation-section').style.display = 'none';
        document.getElementById('policy-implementation-section').style.display = 'none';
        document.getElementById('policy-timeline-section').style.display = 'none';
        
        // Show submit button
        document.getElementById('submit-review-button').style.display = 'block';
      } else {
        // Country is in scope - show everything
        document.getElementById('out-of-scope-message').style.display = 'none';
        
        // Show all elements
        document.getElementById('chw-cards-container').style.display = 'flex';
        document.getElementById('policy-status-card').style.display = 'block';
        document.getElementById('accreditation-section').style.display = 'block';
        document.getElementById('policy-implementation-section').style.display = 'block';
        document.getElementById('policy-timeline-section').style.display = 'block';
        
        // Show submit button
        document.getElementById('submit-review-button').style.display = 'block';
        
        // Populate CHW cards and policy status
        populateCHWCards(countryData);
      }
    }

    // Populate sidebar upon click
    map.on('click', 'country-boundaries', (e) => {
      // Clear previous country's data first
      clearPersistentData();

      const thisCountry = csvData.find(row => row.ISO_A3 === e.features[0].properties.iso_3166_1_alpha_3)

      if (thisCountry) {

        $("#country-name").text(thisCountry.country)
        $("#date-last-updated").text("Date last updated: " + thisCountry.date_last_updated)
        
        // Populate the entire sidebar
        populateSidebar(thisCountry)
      }

    });

    // Create popup on hover
    const popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    map.on('mousemove', 'country-boundaries', (e) => {

      map.getCanvas().style.cursor = 'pointer'

      const thisCountry = csvData.find(row => row.ISO_A3 === e.features[0].properties.iso_3166_1_alpha_3)

      if (thisCountry) {

        popup.setLngLat(e.lngLat)
          .setHTML(
            `
                        <div>
                        ${thisCountry.country}<br> 
                        At least 1 group accredited:
                        ${thisCountry.at_least_1_accredited}<br>
                        At least 1 group salaried:
                        ${thisCountry.at_least_1_salaried}
                        </div>
                        `
          )
          .addTo(map)

      }

    });

    map.on('mouseleave', 'country-boundaries', (e) => {

      map.getCanvas().style.cursor = '';
      popup.remove();

    });

    // Create hover on buttons with definitions - Desktop only
    // Check if device supports hover (desktop/laptop)
    if (window.matchMedia('(hover: hover)').matches) {
      $("#accredited-chws-button").hover(function () {
        $('.accredited-chws-button-def').show();
      }, function () {
        $('.accredited-chws-button-def').hide();
      })

      $("#salaried-chws-button").hover(function () {
        $('.salaried-chws-button-def').show();
      }, function () {
        $('.salaried-chws-button-def').hide();
      })

      $("#accredited-and-salaried-chws-button").hover(function () {
        $('.accredited-and-salaried-chws-button-def').show();
      }, function () {
        $('.accredited-and-salaried-chws-button-def').hide();
      })

      $("#policy-status-button").hover(function () {
        $('.policy-status-button-def').show();
      }, function () {
        $('.policy-status-button-def').hide();
      })

      $("#implementation-evidence-button").hover(function () {
        $('.implementation-evidence-button-def').show();
      }, function () {
        $('.implementation-evidence-button-def').hide();
      })
    }

    // How to Use Dashboard popup functionality
    $("#how-to-use-button").click(function () {
      $("#how-to-use-popup").css("display", "flex");
    });

    $("#close-popup").click(function () {
      $("#how-to-use-popup").css("display", "none");
    });

    // Close popup when clicking outside of it
    $("#how-to-use-popup").click(function (e) {
      if (e.target === this) {
        $(this).css("display", "none");
      }
    });

    // Download Data popup functionality
    $("#download-button").click(function () {
      $("#download-popup").css("display", "flex");
    });

    $("#close-download-popup").click(function () {
      $("#download-popup").css("display", "none");
    });

    // Close download popup when clicking outside of it
    $("#download-popup").click(function (e) {
      if (e.target === this) {
        $(this).css("display", "none");
      }
    });

    // Submit for Review popup functionality
    $("#submit-review-button").click(function () {
      $("#submit-review-popup").css("display", "flex");
    });

    $("#close-submit-review-popup").click(function () {
      $("#submit-review-popup").css("display", "none");
    });

    // Close submit review popup when clicking outside of it
    $("#submit-review-popup").click(function (e) {
      if (e.target === this) {
        $(this).css("display", "none");
      }
    });

    // Handle submission button clicks
    $("#submit-correction-button").click(function () {
      window.open("https://forms.gle/your-correction-form-link", "_blank");
    });

    $("#submit-policy-button").click(function () {
      window.open("https://forms.gle/your-policy-form-link", "_blank");
    });

    $("#submit-association-button").click(function () {
      window.open("https://forms.gle/your-association-form-link", "_blank");
    });

    // Handle download button clicks
    $("#download-map-button").click(function () {
      // Close the popup first
      $("#download-popup").css("display", "none");
      
      // Export high-resolution map
      const canvas = map.getCanvas();
      const originalSize = {
        width: canvas.width,
        height: canvas.height,
      };

      map.resize({
        width: originalSize.width * 5,
        height: originalSize.height * 5,
      });

      map.once('render', () => {
        const dataURL = canvas.toDataURL('image/png');

        const link = document.createElement('a');
        link.href = dataURL;
        link.download = 'chw-policy-map-' + new Date().toISOString().split('T')[0] + '.png';
        link.click();

        map.resize(originalSize);
      });

      map.triggerRepaint();
    });

    $("#download-data-button").click(function () {
      // Download the CSV file
      var link = document.createElement('a');
      link.href = 'https://docs.google.com/spreadsheets/d/1LTB8mJ566h_z1RJEn3D2StMElgN0MMfripYmhaeSQ3Y/export?format=csv';
      link.download = 'chw-policy-data.csv';
      link.click();
      
      // Close the popup
      $("#download-popup").css("display", "none");
    });

    // Close popup with Escape key
    $(document).keydown(function (e) {
      if (e.key === "Escape") {
        if ($("#how-to-use-popup").css("display") === "flex") {
          $("#how-to-use-popup").css("display", "none");
        }
        if ($("#download-popup").css("display") === "flex") {
          $("#download-popup").css("display", "none");
        }
        if ($("#submit-review-popup").css("display") === "flex") {
          $("#submit-review-popup").css("display", "none");
        }
      }
    });

  });

</script>

</body>

</html>